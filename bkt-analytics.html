<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BKT Analytics - studying.works</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="global-styles.css">
    <link rel="stylesheet" href="button-styles.css">

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, getDocs, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD-2SELHboxELp2XLQIwstiI-pCaNcUDOA",
            authDomain: "academie-9942b.firebaseapp.com",
            projectId: "academie-9942b",
            storageBucket: "academie-9942b.firebasestorage.app",
            messagingSenderId: "1079518919325",
            appId: "1:1079518919325:web:745025bdb7b2b23645b274"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseCollection = collection;
        window.firebaseGetDocs = getDocs;
        window.firebaseQuery = query;
        window.firebaseWhere = where;
        window.firebaseOrderBy = orderBy;
        window.firebaseReady = true;
    </script>

    <style>
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .math-formula {
            font-family: 'Courier New', monospace;
            background: rgba(0,0,0,0.1);
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-pink-900" style="background: linear-gradient(to bottom right, #111827, #1e3a8a, #581c87); min-height: 100vh;">
    <script type="module" src="auth-guard.js"></script>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function Navigation() {
            return (
                <nav className="bg-black/30 backdrop-blur-lg border-b border-white/10 fixed top-0 left-0 right-0 z-50">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex items-center justify-between h-16">
                            <div className="flex items-center space-x-8">
                                <a href="dashboard" className="text-2xl font-bold text-white flex items-center space-x-2 hover:scale-105 transition-transform">
                                    <span>üéì</span>
                                    <span>studying.works</span>
                                </a>
                                <div className="hidden md:flex space-x-4">
                                    <a href="dashboard" className="text-white/80 hover:text-white hover:bg-white/10 px-3 py-2 rounded-lg transition-all">Dashboard</a>
                                    <a href="bkt-study" className="text-white/80 hover:text-white hover:bg-white/10 px-3 py-2 rounded-lg transition-all">BKT Study</a>
                                    <a href="bkt-analytics" className="text-white font-semibold px-3 py-2 rounded-lg bg-white/10">BKT Analytics</a>
                                    <a href="custom-flashcards" className="text-white/80 hover:text-white hover:bg-white/10 px-3 py-2 rounded-lg transition-all">My Flashcards</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
            );
        }

        function BKTAnalyticsApp() {
            const [viewMode, setViewMode] = useState('simple'); // simple, technical, or explanation
            const [masteryScores, setMasteryScores] = useState({});
            const [reviews, setReviews] = useState([]);
            const [selectedSkill, setSelectedSkill] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [showAdvancedBKTModal, setShowAdvancedBKTModal] = useState(false);
            const chartRef = useRef(null);
            const skillChartRef = useRef(null);

            useEffect(() => {
                // Wait for authentication before loading data
                if (window.auth) {
                    window.auth.onAuthStateChanged((user) => {
                        if (user) {
                            console.log('‚úÖ User authenticated:', user.email);
                            localStorage.setItem('userId', user.uid);
                            setIsAuthenticated(true);
                            loadData();
                        } else {
                            console.log('‚ùå No authenticated user');
                            setIsAuthenticated(false);
                        }
                    });
                } else {
                    // Fallback: try to load from localStorage cache
                    console.log('‚ö†Ô∏è Firebase Auth not ready, loading from cache');
                    loadData();
                }
            }, []);

            useEffect(() => {
                if (Object.keys(masteryScores).length > 0) {
                    renderMasteryChart();
                }
            }, [masteryScores]);

            useEffect(() => {
                if (selectedSkill && reviews.length > 0) {
                    renderSkillProgressChart();
                }
            }, [selectedSkill, reviews]);

            async function loadData() {
                const userId = localStorage.getItem('userId');

                // Load mastery scores from Firebase first
                if (window.firebaseReady && userId && window.db) {
                    try {
                        console.log('üì• Loading mastery scores from Firebase...');
                        const masteryDocRef = window.firebaseDoc(window.db, 'users', userId, 'data', 'bktMastery');
                        const masteryDoc = await window.firebaseGetDoc(masteryDocRef);

                        if (masteryDoc.exists()) {
                            const data = masteryDoc.data();
                            if (data.scores) {
                                console.log('‚úÖ Loaded mastery scores from Firebase');
                                localStorage.setItem('bkt_mastery_scores', JSON.stringify(data.scores));
                                setMasteryScores(data.scores);
                            }
                        } else {
                            // Fallback to localStorage
                            const savedMastery = localStorage.getItem('bkt_mastery_scores');
                            if (savedMastery) {
                                setMasteryScores(JSON.parse(savedMastery));
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå Error loading mastery scores from Firebase:', error);
                        // Fallback to localStorage
                        const savedMastery = localStorage.getItem('bkt_mastery_scores');
                        if (savedMastery) {
                            setMasteryScores(JSON.parse(savedMastery));
                        }
                    }
                } else {
                    // Fallback to localStorage
                    const savedMastery = localStorage.getItem('bkt_mastery_scores');
                    if (savedMastery) {
                        setMasteryScores(JSON.parse(savedMastery));
                    }
                }

                // Load reviews from Firebase
                if (window.firebaseReady && userId && window.db) {
                    try {
                        console.log('üìä Loading BKT reviews from Firebase...');
                        const reviewsRef = window.firebaseCollection(window.db, 'bkt_reviews');
                        const q = window.firebaseQuery(
                            reviewsRef,
                            window.firebaseWhere('userId', '==', userId),
                            window.firebaseOrderBy('timestamp', 'desc')
                        );

                        const querySnapshot = await window.firebaseGetDocs(q);
                        const firebaseReviews = [];
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            firebaseReviews.push({
                                ...data,
                                timestamp: data.timestamp?.toDate?.()?.toISOString() || new Date().toISOString()
                            });
                        });

                        console.log(`‚úÖ Loaded ${firebaseReviews.length} reviews from Firebase`);
                        setReviews(firebaseReviews);

                        // Also update localStorage as backup
                        localStorage.setItem('bkt_reviews', JSON.stringify(firebaseReviews));
                    } catch (error) {
                        console.error('‚ùå Error loading reviews from Firebase:', error);
                        // Fallback to localStorage
                        const savedReviews = localStorage.getItem('bkt_reviews');
                        if (savedReviews) {
                            setReviews(JSON.parse(savedReviews));
                        }
                    }
                } else {
                    // Fallback to localStorage if Firebase not ready
                    const savedReviews = localStorage.getItem('bkt_reviews');
                    if (savedReviews) {
                        setReviews(JSON.parse(savedReviews));
                    }
                }
            }

            function renderMasteryChart() {
                const ctx = document.getElementById('masteryChart');
                if (!ctx) return;

                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const skills = Object.keys(masteryScores);
                const scores = Object.values(masteryScores);

                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: skills.map(s => s.replace(/-/g, ' ')),
                        datasets: [{
                            label: 'Mastery Score',
                            data: scores,
                            backgroundColor: scores.map(score =>
                                score < 0.5 ? 'rgba(239, 68, 68, 0.8)' :
                                score < 0.8 ? 'rgba(251, 191, 36, 0.8)' :
                                'rgba(34, 197, 94, 0.8)'
                            ),
                            borderColor: scores.map(score =>
                                score < 0.5 ? 'rgba(239, 68, 68, 1)' :
                                score < 0.8 ? 'rgba(251, 191, 36, 1)' :
                                'rgba(34, 197, 94, 1)'
                            ),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1,
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.8)',
                                    callback: function(value) {
                                        return (value * 100) + '%';
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.8)'
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Mastery: ' + Math.round(context.parsed.y * 100) + '%';
                                    }
                                }
                            }
                        },
                        onClick: (e, items) => {
                            if (items.length > 0) {
                                const index = items[0].index;
                                setSelectedSkill(skills[index]);
                            }
                        }
                    }
                });
            }

            function renderSkillProgressChart() {
                const ctx = document.getElementById('skillProgressChart');
                if (!ctx || !selectedSkill) return;

                if (skillChartRef.current) {
                    skillChartRef.current.destroy();
                }

                // Filter reviews for selected skill
                const skillReviews = reviews.filter(r => r.skill === selectedSkill);

                // Calculate mastery over time using simplified BKT
                let mastery = 0.5; // Starting mastery
                const masteryOverTime = [mastery];
                const learningRate = 0.1;
                const slipRate = 0.1;

                skillReviews.forEach(review => {
                    if (review.correct === 1 || review.correct === true) {
                        mastery = mastery + (1 - mastery) * learningRate;
                    } else {
                        mastery = mastery * (1 - slipRate);
                    }
                    masteryOverTime.push(mastery);
                });

                skillChartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: masteryOverTime.length}, (_, i) => i),
                        datasets: [{
                            label: 'Mastery Progress',
                            data: masteryOverTime,
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: skillReviews.map((r, i) =>
                                (r.correct === 1 || r.correct === true) ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)'
                            )
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1,
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.8)',
                                    callback: function(value) {
                                        return (value * 100) + '%';
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Review Number',
                                    color: 'rgba(255, 255, 255, 0.8)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.8)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.8)'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Mastery: ' + Math.round(context.parsed.y * 100) + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function calculateStats() {
                const totalReviews = reviews.length;
                const correctReviews = reviews.filter(r => r.correct === 1 || r.correct === true).length;
                const accuracy = totalReviews > 0 ? (correctReviews / totalReviews) : 0;
                const avgMastery = Object.values(masteryScores).reduce((a, b) => a + b, 0) / Math.max(1, Object.keys(masteryScores).length);

                // Multiple choice specific stats
                const multipleChoiceReviews = reviews.filter(r => r.questionType === 'multiple_choice');
                const flashcardReviews = reviews.filter(r => !r.questionType || r.questionType === 'flashcard');
                const mcCorrect = multipleChoiceReviews.filter(r => r.correct === 1 || r.correct === true).length;
                const fcCorrect = flashcardReviews.filter(r => r.correct === 1 || r.correct === true).length;
                const mcAccuracy = multipleChoiceReviews.length > 0 ? (mcCorrect / multipleChoiceReviews.length) : 0;
                const fcAccuracy = flashcardReviews.length > 0 ? (fcCorrect / flashcardReviews.length) : 0;

                return {
                    totalReviews,
                    correctReviews,
                    accuracy,
                    avgMastery,
                    totalSkills: Object.keys(masteryScores).length,
                    multipleChoiceCount: multipleChoiceReviews.length,
                    flashcardCount: flashcardReviews.length,
                    multipleChoiceAccuracy: mcAccuracy,
                    flashcardAccuracy: fcAccuracy,
                    multipleChoiceCorrect: mcCorrect,
                    flashcardCorrect: fcCorrect
                };
            }

            // Full BKT Training using Expectation-Maximization (EM) Algorithm
            // This implements the same algorithm as pyBKT, but in JavaScript for the browser
            function trainBKTEM(observations, maxIterations = 20) {
                // observations: array of 0s and 1s (incorrect/correct)
                const n = observations.length;
                if (n < 3) {
                    return null; // Not enough data
                }

                // Initialize parameters with reasonable defaults
                let pL0 = 0.4;  // Prior knowledge
                let pT = 0.15;  // Learning rate
                let pS = 0.1;   // Slip rate
                let pG = 0.2;   // Guess rate

                // EM Algorithm
                for (let iter = 0; iter < maxIterations; iter++) {
                    // E-Step: Forward-Backward Algorithm
                    // Calculate P(L_t | observations) for all timesteps

                    // Forward pass
                    const alpha = new Array(n + 1);
                    alpha[0] = pL0; // Initial mastery probability

                    for (let t = 0; t < n; t++) {
                        const obs = observations[t];
                        const pL_t = alpha[t];

                        // P(observation | L_t)
                        const pObsGivenL = obs === 1 ? (1 - pS) : pS;
                        const pObsGivenNotL = obs === 1 ? pG : (1 - pG);

                        // P(L_{t+1} | L_t)
                        const pL_next = pL_t + (1 - pL_t) * pT;

                        // Update using Bayes rule
                        const pObs = pL_t * pObsGivenL + (1 - pL_t) * pObsGivenNotL;
                        const pL_given_obs = pObs > 0 ? (pL_t * pObsGivenL) / pObs : pL_t;

                        alpha[t + 1] = pL_given_obs + (1 - pL_given_obs) * pT;
                    }

                    // M-Step: Update parameters based on expected counts

                    // Count expected transitions and emissions
                    let expectedLearn = 0;
                    let expectedNotLearn = 0;
                    let expectedSlip = 0;
                    let expectedNoSlip = 0;
                    let expectedGuess = 0;
                    let expectedNoGuess = 0;

                    for (let t = 0; t < n; t++) {
                        const obs = observations[t];
                        const pL_t = alpha[t];

                        // Expected learning transitions
                        if (t > 0) {
                            const pNotL_prev = 1 - alpha[t - 1];
                            const pL_curr = alpha[t];
                            expectedLearn += pNotL_prev * pT * (pL_curr / (alpha[t - 1] + pNotL_prev * pT + 1e-10));
                            expectedNotLearn += pNotL_prev * (1 - pT);
                        }

                        // Expected slips and guesses
                        if (obs === 0) {
                            // Incorrect answer
                            expectedSlip += pL_t;
                            expectedNoGuess += (1 - pL_t);
                        } else {
                            // Correct answer
                            expectedNoSlip += pL_t;
                            expectedGuess += (1 - pL_t);
                        }
                    }

                    // Update parameters
                    const newPL0 = alpha[0];
                    const newPT = expectedLearn / Math.max(expectedLearn + expectedNotLearn, 1e-10);
                    const newPS = expectedSlip / Math.max(expectedSlip + expectedNoSlip, 1e-10);
                    const newPG = expectedGuess / Math.max(expectedGuess + expectedNoGuess, 1e-10);

                    // Constrain parameters to valid ranges
                    pL0 = Math.max(0.01, Math.min(0.99, newPL0));
                    pT = Math.max(0.01, Math.min(0.5, newPT));
                    pS = Math.max(0.01, Math.min(0.4, newPS));
                    pG = Math.max(0.01, Math.min(0.5, newPG));

                    // Check for convergence (optional)
                    const change = Math.abs(newPT - pT) + Math.abs(newPS - pS) + Math.abs(newPG - pG);
                    if (change < 0.001) {
                        console.log(`   Converged after ${iter + 1} iterations`);
                        break;
                    }
                }

                return {
                    prior: Math.round(pL0 * 1000) / 1000,
                    learn: Math.round(pT * 1000) / 1000,
                    slip: Math.round(pS * 1000) / 1000,
                    guess: Math.round(pG * 1000) / 1000
                };
            }

            // Client-side Advanced BKT Training
            async function trainAdvancedBKT() {
                if (reviews.length < 20) {
                    alert('You need at least 20 reviews to train BKT. Keep studying!');
                    return;
                }

                console.log('üéì Starting Full BKT Training with EM Algorithm...');
                console.log(`   Using ${reviews.length} reviews across all skills`);

                // Group reviews by skill
                const skillGroups = {};
                reviews.forEach(review => {
                    if (!skillGroups[review.skill]) {
                        skillGroups[review.skill] = [];
                    }
                    skillGroups[review.skill].push(review);
                });

                const advancedParams = {};
                let skillsTrainedCount = 0;

                // Train BKT model for each skill using EM algorithm
                Object.keys(skillGroups).forEach(skill => {
                    const skillReviews = skillGroups[skill].sort((a, b) => {
                        const timeA = a.timestamp?.seconds || new Date(a.timestamp).getTime() / 1000;
                        const timeB = b.timestamp?.seconds || new Date(b.timestamp).getTime() / 1000;
                        return timeA - timeB;
                    });

                    if (skillReviews.length < 5) {
                        // Not enough data for this skill, use defaults
                        console.log(`   ‚ö†Ô∏è  Skipping ${skill} (only ${skillReviews.length} reviews)`);
                        advancedParams[skill] = {
                            prior: 0.4,
                            learn: 0.15,
                            slip: 0.1,
                            guess: 0.2
                        };
                        return;
                    }

                    console.log(`   üîÑ Training ${skill} (${skillReviews.length} reviews)...`);

                    // Extract observations (0 = incorrect, 1 = correct)
                    const observations = skillReviews.map(r => {
                        return (r.correct === 1 || r.correct === true) ? 1 : 0;
                    });

                    // Train using EM algorithm
                    const params = trainBKTEM(observations, 20);

                    if (params) {
                        advancedParams[skill] = params;
                        skillsTrainedCount++;
                        console.log(`   ‚úÖ ${skill}:`, params);
                    } else {
                        // Fallback to defaults
                        advancedParams[skill] = {
                            prior: 0.4,
                            learn: 0.15,
                            slip: 0.1,
                            guess: 0.2
                        };
                    }
                });

                // Save to localStorage and Firebase in per-user format
                const userId = localStorage.getItem('userId');

                // Load existing user params or create new structure
                let allUserParams = {};
                const existingParamsStr = localStorage.getItem('bkt_user_params');
                if (existingParamsStr) {
                    try {
                        allUserParams = JSON.parse(existingParamsStr);
                    } catch (e) {
                        console.error('Error loading existing params:', e);
                    }
                }

                // Update this user's parameters
                allUserParams[userId] = advancedParams;

                // Save back to localStorage
                localStorage.setItem('bkt_user_params', JSON.stringify(allUserParams));
                console.log('‚úÖ Saved personalized parameters for user:', userId);

                // Save to Firebase
                if (window.firebaseReady && userId && window.db) {
                    try {
                        const { setDoc } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');
                        const paramsDocRef = window.firebaseDoc(window.db, 'users', userId, 'data', 'bktUserParams');
                        await setDoc(paramsDocRef, {
                            params: advancedParams,
                            trainedAt: new Date(),
                            reviewCount: reviews.length,
                            trainingMethod: 'quick-train'
                        });
                        console.log('‚úÖ Personalized BKT parameters saved to Firebase');
                    } catch (error) {
                        console.error('‚ùå Error saving to Firebase:', error);
                    }
                }

                console.log(`\n‚úÖ Training Complete!`);
                console.log(`   Skills trained with EM: ${skillsTrainedCount}`);
                console.log(`   Total skills: ${Object.keys(advancedParams).length}`);

                alert(`üéâ Full BKT Training Complete!\n\n‚úÖ Trained ${skillsTrainedCount} skills using Expectation-Maximization algorithm\nüìä Based on ${reviews.length} reviews\nüéØ Parameters optimized for YOUR learning patterns\n\nThe app will now adapt specifically to how YOU learn!`);

                setShowAdvancedBKTModal(false);

                // Reload the page to reflect changes
                setTimeout(() => window.location.reload(), 1000);
            }

            const stats = calculateStats();

            return (
                <div className="min-h-screen">
                    <Navigation />
                    <div className="pt-24 p-6 pb-12">
                        <div className="max-w-7xl mx-auto">
                            {/* Header */}
                            <div className="mb-8">
                                <h1 className="text-5xl font-bold text-white mb-2">üìä BKT Analytics</h1>
                                <p className="text-xl text-blue-200">Deep dive into your learning data</p>
                            </div>

                            {/* View Toggle */}
                            <div className="bg-white/10 backdrop-blur rounded-2xl p-2 inline-flex mb-8">
                                <button
                                    onClick={() => setViewMode('simple')}
                                    className={`px-6 py-3 rounded-xl font-semibold transition-all ${
                                        viewMode === 'simple'
                                            ? 'bg-white text-gray-900'
                                            : 'text-white/70 hover:text-white'
                                    }`}
                                >
                                    üéØ Simple View
                                </button>
                                <button
                                    onClick={() => setViewMode('explanation')}
                                    className={`px-6 py-3 rounded-xl font-semibold transition-all ${
                                        viewMode === 'explanation'
                                            ? 'bg-white text-gray-900'
                                            : 'text-white/70 hover:text-white'
                                    }`}
                                >
                                    üìñ Explanation
                                </button>
                                <button
                                    onClick={() => setViewMode('technical')}
                                    className={`px-6 py-3 rounded-xl font-semibold transition-all ${
                                        viewMode === 'technical'
                                            ? 'bg-white text-gray-900'
                                            : 'text-white/70 hover:text-white'
                                    }`}
                                >
                                    üßÆ Technical View
                                </button>
                            </div>

                            {/* Advanced BKT Mode Banner */}
                            {stats.totalReviews >= 20 && (
                                <div className="mb-8 bg-gradient-to-r from-purple-500/30 via-pink-500/30 to-orange-500/30 backdrop-blur rounded-2xl p-6 border-2 border-purple-400/50 animate-pulse-slow">
                                    <div className="flex items-start justify-between gap-4">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-3 mb-3">
                                                <div className="text-4xl">üéì</div>
                                                <h3 className="text-2xl font-bold text-white">Advanced BKT Mode Ready!</h3>
                                            </div>
                                            <p className="text-white/90 mb-4">
                                                Congratulations! You've completed <strong>{stats.totalReviews} reviews</strong> - enough data to unlock
                                                personalized BKT parameters. Advanced mode will learn YOUR unique learning patterns for each skill.
                                            </p>
                                            <div className="flex gap-3">
                                                <button
                                                    onClick={() => setShowAdvancedBKTModal(true)}
                                                    className="bg-white text-purple-900 px-6 py-3 rounded-xl font-bold hover:scale-105 transition-transform shadow-lg"
                                                >
                                                    üöÄ Train BKT Model
                                                </button>
                                                <a
                                                    href="https://github.com/Benpitt/studying.works/blob/main/BKT_FIREBASE_SUMMARY.md"
                                                    target="_blank"
                                                    className="bg-white/10 text-white px-6 py-3 rounded-xl font-semibold hover:bg-white/20 transition-all border border-white/20"
                                                >
                                                    üìö Learn More
                                                </a>
                                            </div>
                                        </div>
                                        <button
                                            onClick={(e) => e.currentTarget.parentElement.parentElement.style.display = 'none'}
                                            className="text-white/60 hover:text-white text-2xl"
                                        >
                                            √ó
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Advanced BKT Modal */}
                            {showAdvancedBKTModal && (
                                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                                    <div className="bg-gradient-to-br from-gray-900 to-purple-900 rounded-2xl p-8 max-w-2xl w-full border-2 border-purple-400/50 max-h-[90vh] overflow-y-auto">
                                        <div className="flex justify-between items-start mb-6">
                                            <div>
                                                <h2 className="text-3xl font-bold text-white mb-2">üéì Train Personalized BKT Model</h2>
                                                <p className="text-white/70">Full EM algorithm - no Python required!</p>
                                            </div>
                                            <button
                                                onClick={() => setShowAdvancedBKTModal(false)}
                                                className="text-white/60 hover:text-white text-3xl"
                                            >
                                                √ó
                                            </button>
                                        </div>

                                        <div className="space-y-6">
                                            {/* What You'll Get */}
                                            <div className="bg-white/10 p-6 rounded-xl">
                                                <h3 className="text-xl font-bold text-white mb-4">‚ú® What You'll Get</h3>
                                                <ul className="space-y-3 text-white/90">
                                                    <li className="flex gap-3">
                                                        <span>üéØ</span>
                                                        <span><strong>Personalized Learning Rates:</strong> The system learns how quickly YOU master each skill</span>
                                                    </li>
                                                    <li className="flex gap-3">
                                                        <span>üìä</span>
                                                        <span><strong>Skill-Specific Parameters:</strong> Different topics get different P(L‚ÇÄ), P(T), P(S), P(G) values based on your performance</span>
                                                    </li>
                                                    <li className="flex gap-3">
                                                        <span>üéì</span>
                                                        <span><strong>More Accurate Predictions:</strong> Better mastery estimates = more efficient studying</span>
                                                    </li>
                                                </ul>
                                            </div>

                                            {/* How It Works */}
                                            <div className="bg-gradient-to-br from-blue-500/20 to-purple-500/20 p-6 rounded-xl border border-blue-400/30">
                                                <h3 className="text-xl font-bold text-white mb-4">üöÄ How It Works</h3>
                                                <p className="text-white/90 mb-4">
                                                    Uses <strong>Expectation-Maximization (EM) algorithm</strong> to train a full BKT model on your <strong>{stats.totalReviews} reviews</strong>, calculating personalized parameters for each of your <strong>{stats.totalSkills} skills</strong>.
                                                </p>
                                                <div className="space-y-3 text-sm text-white/80">
                                                    <div className="flex gap-3">
                                                        <span>üß†</span>
                                                        <span><strong>Full BKT Implementation:</strong> Same algorithm as pyBKT, runs in browser</span>
                                                    </div>
                                                    <div className="flex gap-3">
                                                        <span>üìà</span>
                                                        <span><strong>Forward-Backward:</strong> Computes mastery probabilities at each timestep</span>
                                                    </div>
                                                    <div className="flex gap-3">
                                                        <span>üîÑ</span>
                                                        <span><strong>EM Optimization:</strong> Iteratively maximizes likelihood (converges in ~10-20 iterations)</span>
                                                    </div>
                                                    <div className="flex gap-3">
                                                        <span>üéØ</span>
                                                        <span><strong>Per-Skill Training:</strong> Each skill gets optimized P(L‚ÇÄ), P(T), P(S), P(G)</span>
                                                    </div>
                                                    <div className="flex gap-3">
                                                        <span>üíæ</span>
                                                        <span><strong>Auto-Save:</strong> Parameters saved to localStorage and Firebase</span>
                                                    </div>
                                                    <div className="flex gap-3">
                                                        <span>‚ö°</span>
                                                        <span><strong>Fast:</strong> Completes in seconds, no Python/repo access needed!</span>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Current Stats */}
                                            <div className="bg-white/5 p-5 rounded-xl">
                                                <h3 className="font-bold text-white mb-4">üìä Your Training Data</h3>
                                                <div className="grid grid-cols-3 gap-4 text-center">
                                                    <div>
                                                        <div className="text-3xl font-bold text-green-400">{stats.totalReviews}</div>
                                                        <div className="text-white/60 text-sm">Reviews</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-3xl font-bold text-blue-400">{stats.totalSkills}</div>
                                                        <div className="text-white/60 text-sm">Skills</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-3xl font-bold text-purple-400">{Math.round(stats.totalReviews / Math.max(1, stats.totalSkills))}</div>
                                                        <div className="text-white/60 text-sm">Avg/Skill</div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Ready to Train */}
                                            <div className="bg-gradient-to-r from-green-500/20 to-emerald-500/20 border border-green-500/50 p-5 rounded-xl">
                                                <div className="flex gap-3 items-start">
                                                    <span className="text-3xl">‚úÖ</span>
                                                    <div>
                                                        <div className="font-bold text-green-300 text-lg mb-2">Ready to Train!</div>
                                                        <p className="text-white/80 text-sm">
                                                            You have enough data to create personalized BKT parameters. This will make your future study sessions even more effective by adapting to your unique learning patterns.
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Action Buttons */}
                                            <div className="flex gap-4">
                                                <button
                                                    onClick={trainAdvancedBKT}
                                                    className="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-4 rounded-xl font-bold text-center hover:scale-105 transition-transform shadow-lg text-lg"
                                                >
                                                    üöÄ Train Now
                                                </button>
                                                <button
                                                    onClick={() => setShowAdvancedBKTModal(false)}
                                                    className="bg-white/10 text-white px-6 py-4 rounded-xl font-semibold hover:bg-white/20 transition-all border border-white/20"
                                                >
                                                    Cancel
                                                </button>
                                            </div>

                                            <div className="text-center">
                                                <a
                                                    href="https://github.com/Benpitt/studying.works/blob/main/BKT_FIREBASE_SUMMARY.md"
                                                    target="_blank"
                                                    className="text-blue-300 hover:text-blue-200 text-sm underline"
                                                >
                                                    üìñ Learn more about Advanced BKT
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Simple View */}
                            {viewMode === 'simple' && (
                                <div className="space-y-8">
                                    {/* Stats Overview */}
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                        <div className="card-gradient-blue rounded-2xl p-6 text-white card-hover">
                                            <div className="text-5xl mb-2">üìö</div>
                                            <div className="text-3xl font-bold mb-1">{stats.totalSkills}</div>
                                            <div className="text-blue-100">Skills Tracked</div>
                                        </div>
                                        <div className="card-gradient-success rounded-2xl p-6 text-white card-hover">
                                            <div className="text-5xl mb-2">‚úÖ</div>
                                            <div className="text-3xl font-bold mb-1">{Math.round(stats.avgMastery * 100)}%</div>
                                            <div className="text-green-100">Avg Mastery</div>
                                        </div>
                                        <div className="card-gradient-purple rounded-2xl p-6 text-white card-hover">
                                            <div className="text-5xl mb-2">üéØ</div>
                                            <div className="text-3xl font-bold mb-1">{stats.totalReviews}</div>
                                            <div className="text-purple-100">Total Reviews</div>
                                        </div>
                                        <div className="card-gradient-fire rounded-2xl p-6 text-white card-hover">
                                            <div className="text-5xl mb-2">üî•</div>
                                            <div className="text-3xl font-bold mb-1">{Math.round(stats.accuracy * 100)}%</div>
                                            <div className="text-orange-100">Accuracy</div>
                                        </div>
                                    </div>

                                    {/* Question Type Breakdown - Only show if multiple choice questions exist */}
                                    {stats.multipleChoiceCount > 0 && (
                                        <div className="bg-white/10 backdrop-blur rounded-2xl p-6 border border-white/20">
                                            <h2 className="text-2xl font-bold text-white mb-4 flex items-center">
                                                <span>üìù</span>
                                                <span className="ml-2">Question Type Performance</span>
                                            </h2>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                {/* Multiple Choice Stats */}
                                                <div className="bg-white/5 rounded-xl p-6">
                                                    <div className="flex items-center justify-between mb-4">
                                                        <h3 className="text-xl font-bold text-white">Multiple Choice</h3>
                                                        <span className="text-3xl">üìù</span>
                                                    </div>
                                                    <div className="space-y-3">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-white/70">Total Questions:</span>
                                                            <span className="text-white font-bold text-lg">{stats.multipleChoiceCount}</span>
                                                        </div>
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-white/70">Correct:</span>
                                                            <span className="text-green-400 font-bold text-lg">{stats.multipleChoiceCorrect}</span>
                                                        </div>
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-white/70">Accuracy:</span>
                                                            <span className="text-white font-bold text-2xl">{Math.round(stats.multipleChoiceAccuracy * 100)}%</span>
                                                        </div>
                                                        <div className="w-full bg-white/20 rounded-full h-3 mt-2">
                                                            <div
                                                                className="h-3 rounded-full transition-all"
                                                                style={{
                                                                    width: `${Math.round(stats.multipleChoiceAccuracy * 100)}%`,
                                                                    background: stats.multipleChoiceAccuracy < 0.5 ? 'linear-gradient(to right, #ef4444, #f97316)' :
                                                                               stats.multipleChoiceAccuracy < 0.8 ? 'linear-gradient(to right, #f97316, #eab308)' :
                                                                               'linear-gradient(to right, #22c55e, #10b981)'
                                                                }}
                                                            />
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Flashcard Stats */}
                                                <div className="bg-white/5 rounded-xl p-6">
                                                    <div className="flex items-center justify-between mb-4">
                                                        <h3 className="text-xl font-bold text-white">Flashcards</h3>
                                                        <span className="text-3xl">üéØ</span>
                                                    </div>
                                                    <div className="space-y-3">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-white/70">Total Questions:</span>
                                                            <span className="text-white font-bold text-lg">{stats.flashcardCount}</span>
                                                        </div>
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-white/70">Correct:</span>
                                                            <span className="text-green-400 font-bold text-lg">{stats.flashcardCorrect}</span>
                                                        </div>
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-white/70">Accuracy:</span>
                                                            <span className="text-white font-bold text-2xl">{Math.round(stats.flashcardAccuracy * 100)}%</span>
                                                        </div>
                                                        <div className="w-full bg-white/20 rounded-full h-3 mt-2">
                                                            <div
                                                                className="h-3 rounded-full transition-all"
                                                                style={{
                                                                    width: `${Math.round(stats.flashcardAccuracy * 100)}%`,
                                                                    background: stats.flashcardAccuracy < 0.5 ? 'linear-gradient(to right, #ef4444, #f97316)' :
                                                                               stats.flashcardAccuracy < 0.8 ? 'linear-gradient(to right, #f97316, #eab308)' :
                                                                               'linear-gradient(to right, #22c55e, #10b981)'
                                                                }}
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Mastery Chart */}
                                    <div className="bg-white/10 backdrop-blur rounded-2xl p-6 border border-white/20">
                                        <h2 className="text-2xl font-bold text-white mb-4 flex items-center">
                                            <span>üìä</span>
                                            <span className="ml-2">Mastery by Skill</span>
                                        </h2>
                                        <p className="text-white/70 mb-4 text-sm">Click on a bar to see detailed progress</p>
                                        {Object.keys(masteryScores).length > 0 ? (
                                            <div style={{height: '300px'}}>
                                                <canvas id="masteryChart"></canvas>
                                            </div>
                                        ) : (
                                            <div className="text-center py-12 text-white/60">
                                                <div className="text-6xl mb-4">üìö</div>
                                                <p>No data yet! Start studying with BKT to see your progress.</p>
                                            </div>
                                        )}
                                    </div>

                                    {/* Selected Skill Progress */}
                                    {selectedSkill && (
                                        <div className="bg-white/10 backdrop-blur rounded-2xl p-6 border border-white/20">
                                            <div className="flex justify-between items-center mb-4">
                                                <h2 className="text-2xl font-bold text-white flex items-center">
                                                    <span>üìà</span>
                                                    <span className="ml-2">Progress: {selectedSkill.replace(/-/g, ' ')}</span>
                                                </h2>
                                                <button
                                                    onClick={() => setSelectedSkill(null)}
                                                    className="text-white/60 hover:text-white"
                                                >
                                                    ‚úï Close
                                                </button>
                                            </div>
                                            <div style={{height: '300px'}}>
                                                <canvas id="skillProgressChart"></canvas>
                                            </div>
                                            <div className="mt-4 grid grid-cols-2 gap-4 text-sm">
                                                <div className="bg-white/5 p-3 rounded-lg">
                                                    <div className="text-white/60 mb-1">Total Reviews</div>
                                                    <div className="text-white font-bold text-xl">
                                                        {reviews.filter(r => r.skill === selectedSkill).length}
                                                    </div>
                                                </div>
                                                <div className="bg-white/5 p-3 rounded-lg">
                                                    <div className="text-white/60 mb-1">Current Mastery</div>
                                                    <div className="text-white font-bold text-xl">
                                                        {Math.round(masteryScores[selectedSkill] * 100)}%
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Simple Explanation */}
                                    <div className="card-gradient-indigo rounded-2xl p-6">
                                        <h2 className="text-2xl font-bold text-white mb-4">üí° How BKT Works (Simple)</h2>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-white">
                                            <div className="bg-white/10 p-4 rounded-xl">
                                                <div className="text-3xl mb-2">üéØ</div>
                                                <div className="font-bold mb-2">Mastery Score (0-100%)</div>
                                                <div className="text-sm text-white/90">
                                                    How well the system thinks you know this topic. Starts at 50% and changes based on your answers.
                                                </div>
                                            </div>
                                            <div className="bg-white/10 p-4 rounded-xl">
                                                <div className="text-3xl mb-2">‚úÖ</div>
                                                <div className="font-bold mb-2">Correct Answer</div>
                                                <div className="text-sm text-white/90">
                                                    Increases your mastery score. The system becomes more confident you know it.
                                                </div>
                                            </div>
                                            <div className="bg-white/10 p-4 rounded-xl">
                                                <div className="text-3xl mb-2">‚ùå</div>
                                                <div className="font-bold mb-2">Wrong Answer</div>
                                                <div className="text-sm text-white/90">
                                                    Decreases your mastery score. Shows you need more practice on this topic.
                                                </div>
                                            </div>
                                            <div className="bg-white/10 p-4 rounded-xl">
                                                <div className="text-3xl mb-2">üîÑ</div>
                                                <div className="font-bold mb-2">Smart Prioritization</div>
                                                <div className="text-sm text-white/90">
                                                    BKT shows you topics with lower mastery first, making study time more efficient.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Explanation View */}
                            {viewMode === 'explanation' && (
                                <div className="space-y-8">
                                    {/* What is BKT */}
                                    <div className="bg-gradient-to-br from-blue-500/20 to-purple-500/20 backdrop-blur rounded-2xl p-8 border border-white/20">
                                        <h2 className="text-3xl font-bold text-white mb-6">üéì What is Bayesian Knowledge Tracing?</h2>
                                        <div className="text-white/90 text-lg space-y-4">
                                            <p>
                                                Imagine you have a study buddy who's watching you practice. Every time you answer a question,
                                                your buddy updates their estimate of how well you know that topic. <strong>That's exactly what BKT does!</strong>
                                            </p>
                                            <p>
                                                BKT is like having an intelligent tutor that tracks your knowledge in real-time. It doesn't just
                                                count right and wrong answers - it understands that learning is complex and uncertain.
                                            </p>
                                        </div>
                                    </div>

                                    {/* The Story of Learning */}
                                    <div className="bg-white/10 backdrop-blur rounded-2xl p-6 border border-white/20">
                                        <h2 className="text-2xl font-bold text-white mb-6">üìö The Story of How You Learn</h2>
                                        <div className="space-y-6">
                                            {/* Step 1 */}
                                            <div className="flex gap-4">
                                                <div className="flex-shrink-0 w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-2xl">
                                                    1Ô∏è‚É£
                                                </div>
                                                <div className="flex-1">
                                                    <h3 className="text-xl font-bold text-white mb-2">You Start at 50/50</h3>
                                                    <p className="text-white/80">
                                                        When you first see a new topic, BKT assumes you might know it or might not - it's a fair starting point.
                                                        Think of it like flipping a coin: 50% chance you already know it.
                                                    </p>
                                                </div>
                                            </div>

                                            {/* Step 2 */}
                                            <div className="flex gap-4">
                                                <div className="flex-shrink-0 w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-2xl">
                                                    2Ô∏è‚É£
                                                </div>
                                                <div className="flex-1">
                                                    <h3 className="text-xl font-bold text-white mb-2">You Answer a Question Correctly ‚úÖ</h3>
                                                    <p className="text-white/80">
                                                        Great! Your mastery score goes UP. But here's the smart part: BKT knows you might have just gotten lucky
                                                        and guessed right. So it increases your score, but not all the way to 100%. It's being cautiously optimistic.
                                                    </p>
                                                </div>
                                            </div>

                                            {/* Step 3 */}
                                            <div className="flex gap-4">
                                                <div className="flex-shrink-0 w-12 h-12 bg-red-500 rounded-full flex items-center justify-center text-2xl">
                                                    3Ô∏è‚É£
                                                </div>
                                                <div className="flex-1">
                                                    <h3 className="text-xl font-bold text-white mb-2">You Answer a Question Wrong ‚ùå</h3>
                                                    <p className="text-white/80">
                                                        Oops! Your mastery score goes DOWN. But BKT is fair - it knows that even experts sometimes make mistakes
                                                        (called "slips"). Maybe you knew it but clicked the wrong button! So your score drops, but not all the
                                                        way to zero.
                                                    </p>
                                                </div>
                                            </div>

                                            {/* Step 4 */}
                                            <div className="flex gap-4">
                                                <div className="flex-shrink-0 w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center text-2xl">
                                                    4Ô∏è‚É£
                                                </div>
                                                <div className="flex-1">
                                                    <h3 className="text-xl font-bold text-white mb-2">The Pattern Emerges üìà</h3>
                                                    <p className="text-white/80">
                                                        As you practice more, BKT builds a clearer picture of your knowledge. If you keep getting questions right,
                                                        your mastery score climbs toward 100%. If you struggle, it stays lower - signaling you need more practice.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Why This Matters */}
                                    <div className="bg-gradient-to-br from-green-500/20 to-emerald-500/20 backdrop-blur rounded-2xl p-8 border border-white/20">
                                        <h2 className="text-2xl font-bold text-white mb-6">üí° Why This Matters for Your Learning</h2>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="bg-white/10 p-6 rounded-xl">
                                                <div className="text-4xl mb-3">üéØ</div>
                                                <h3 className="font-bold text-white text-lg mb-2">Smarter Practice</h3>
                                                <p className="text-white/80">
                                                    BKT shows you the topics you need most. No more wasting time on things you already know perfectly!
                                                </p>
                                            </div>
                                            <div className="bg-white/10 p-6 rounded-xl">
                                                <div className="text-4xl mb-3">‚ö°</div>
                                                <h3 className="font-bold text-white text-lg mb-2">Faster Learning</h3>
                                                <p className="text-white/80">
                                                    By focusing on your weak spots, you learn more efficiently. It's like having a personal tutor
                                                    who knows exactly what you need.
                                                </p>
                                            </div>
                                            <div className="bg-white/10 p-6 rounded-xl">
                                                <div className="text-4xl mb-3">üìä</div>
                                                <h3 className="font-bold text-white text-lg mb-2">Track Your Progress</h3>
                                                <p className="text-white/80">
                                                    See your mastery scores rise over time. It's incredibly motivating to watch yourself improve!
                                                </p>
                                            </div>
                                            <div className="bg-white/10 p-6 rounded-xl">
                                                <div className="text-4xl mb-3">üß†</div>
                                                <h3 className="font-bold text-white text-lg mb-2">Science-Backed</h3>
                                                <p className="text-white/80">
                                                    BKT is used by major educational platforms and backed by research. You're using a proven method!
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* The Magic Behind It */}
                                    <div className="bg-white/10 backdrop-blur rounded-2xl p-6 border border-white/20">
                                        <h2 className="text-2xl font-bold text-white mb-6">‚ú® The Magic Behind the Scenes</h2>
                                        <div className="space-y-4 text-white/90">
                                            <div className="bg-white/5 p-5 rounded-xl">
                                                <h3 className="font-bold text-blue-300 mb-3 text-lg">üé≤ BKT Knows You Might Guess</h3>
                                                <p>
                                                    Got a multiple-choice question right? BKT considers you might have been lucky. That's why one
                                                    correct answer doesn't immediately make you a master - it takes consistent performance.
                                                </p>
                                            </div>
                                            <div className="bg-white/5 p-5 rounded-xl">
                                                <h3 className="font-bold text-yellow-300 mb-3 text-lg">üòÖ BKT Knows You Might Slip</h3>
                                                <p>
                                                    Made a mistake even though you know the material? BKT gets it. One wrong answer doesn't destroy
                                                    your mastery score - because humans make silly mistakes sometimes!
                                                </p>
                                            </div>
                                            <div className="bg-white/5 p-5 rounded-xl">
                                                <h3 className="font-bold text-green-300 mb-3 text-lg">üìà BKT Knows You're Learning</h3>
                                                <p>
                                                    With each practice session, you're building neural pathways. BKT models this gradual improvement
                                                    by increasing your mastery bit by bit as you prove you know the material.
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Simple vs Advanced */}
                                    <div className="bg-gradient-to-br from-indigo-500/20 to-pink-500/20 backdrop-blur rounded-2xl p-8 border border-white/20">
                                        <h2 className="text-2xl font-bold text-white mb-6">üöÄ Simple BKT vs. Advanced BKT</h2>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="bg-white/10 p-6 rounded-xl border-2 border-blue-400/50">
                                                <div className="text-3xl mb-3">üéØ</div>
                                                <h3 className="font-bold text-white text-xl mb-3">Simple BKT (Current)</h3>
                                                <ul className="text-white/80 space-y-2 text-sm">
                                                    <li>‚úì Works right away</li>
                                                    <li>‚úì Uses standard learning rates for everyone</li>
                                                    <li>‚úì Same rules for all topics</li>
                                                    <li>‚úì Already helping you learn better!</li>
                                                </ul>
                                            </div>
                                            <div className="bg-white/10 p-6 rounded-xl border-2 border-purple-400/50">
                                                <div className="text-3xl mb-3">üéì</div>
                                                <h3 className="font-bold text-white text-xl mb-3">Advanced BKT (Unlock at 100+ reviews)</h3>
                                                <ul className="text-white/80 space-y-2 text-sm">
                                                    <li>‚úì Personalized to YOUR learning style</li>
                                                    <li>‚úì Different rates for different topics</li>
                                                    <li>‚úì Learns from YOUR specific patterns</li>
                                                    <li>‚úì Even more accurate predictions!</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div className="mt-6 bg-yellow-500/20 border border-yellow-500/50 p-4 rounded-lg">
                                            <div className="flex items-start gap-3">
                                                <div className="text-2xl">üí°</div>
                                                <div>
                                                    <div className="font-bold text-yellow-300 mb-2">Pro Tip</div>
                                                    <p className="text-white/80 text-sm">
                                                        Keep studying and once you hit 20+ reviews, you can train your personalized BKT model!
                                                        The system will learn YOUR unique learning patterns and become even better at helping you master topics.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Bottom Line */}
                                    <div className="bg-gradient-to-r from-purple-500/30 to-pink-500/30 backdrop-blur rounded-2xl p-8 border border-white/20">
                                        <h2 className="text-2xl font-bold text-white mb-4">üéØ The Bottom Line</h2>
                                        <p className="text-white/90 text-lg leading-relaxed">
                                            BKT is your intelligent study companion that watches how you learn, understands the uncertainty
                                            in the learning process (guessing, slipping, gradual improvement), and helps you focus on what
                                            matters most. It's not just tracking if you're right or wrong - it's modeling your journey to mastery.
                                        </p>
                                        <p className="text-white/80 mt-4 italic">
                                            Think of it as having a wise mentor who knows when to challenge you with harder material and
                                            when to give you more practice on the basics. All backed by mathematics and cognitive science! üìö
                                        </p>
                                    </div>
                                </div>
                            )}

                            {/* Technical View */}
                            {viewMode === 'technical' && (
                                <div className="space-y-8">
                                    {/* BKT Algorithm Explanation */}
                                    <div className="bg-white/10 backdrop-blur rounded-2xl p-6 border border-white/20">
                                        <h2 className="text-3xl font-bold text-white mb-6 flex items-center">
                                            <span>üßÆ</span>
                                            <span className="ml-2">Bayesian Knowledge Tracing Algorithm</span>
                                        </h2>

                                        <div className="space-y-6 text-white">
                                            <div>
                                                <h3 className="text-xl font-bold mb-3 text-blue-300">1. Core BKT Equation</h3>
                                                <div className="math-formula text-sm">
                                                    P(L<sub>n</sub>) = P(L<sub>n-1</sub> | evidence)
                                                    <br/><br/>
                                                    Where:
                                                    <br/>‚Ä¢ P(L<sub>n</sub>) = Probability of knowing skill after n attempts (mastery)
                                                    <br/>‚Ä¢ Evidence = Observed correctness of answer
                                                </div>
                                            </div>

                                            <div>
                                                <h3 className="text-xl font-bold mb-3 text-green-300">2. Four Key Parameters</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div className="bg-white/5 p-4 rounded-lg">
                                                        <div className="font-bold text-green-400 mb-2">P(L‚ÇÄ) - Prior Knowledge</div>
                                                        <div className="text-sm text-white/80">
                                                            Initial probability student knows skill before any practice
                                                            <div className="math-formula mt-2 text-xs">
                                                                Current: 0.5 (50%)
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="bg-white/5 p-4 rounded-lg">
                                                        <div className="font-bold text-blue-400 mb-2">P(T) - Learn/Transit Rate</div>
                                                        <div className="text-sm text-white/80">
                                                            Probability of learning skill on each practice attempt
                                                            <div className="math-formula mt-2 text-xs">
                                                                Current: 0.1 (10% per correct)
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="bg-white/5 p-4 rounded-lg">
                                                        <div className="font-bold text-yellow-400 mb-2">P(S) - Slip Rate</div>
                                                        <div className="text-sm text-white/80">
                                                            Probability of answering wrong despite knowing the skill
                                                            <div className="math-formula mt-2 text-xs">
                                                                Current: 0.1 (10% slip chance)
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="bg-white/5 p-4 rounded-lg">
                                                        <div className="font-bold text-purple-400 mb-2">P(G) - Guess Rate</div>
                                                        <div className="text-sm text-white/80">
                                                            Probability of answering correctly by lucky guess
                                                            <div className="math-formula mt-2 text-xs">
                                                                Current: 0.2 (20% guess chance)
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div>
                                                <h3 className="text-xl font-bold mb-3 text-orange-300">3. Update Formulas</h3>
                                                <div className="space-y-4">
                                                    <div className="bg-green-500/20 p-4 rounded-lg border border-green-500/50">
                                                        <div className="font-bold mb-2">When Answer is CORRECT:</div>
                                                        <div className="math-formula text-sm">
                                                            P(L<sub>n</sub>) = P(L<sub>n-1</sub>) + (1 - P(L<sub>n-1</sub>)) √ó P(T)
                                                            <br/><br/>
                                                            Example: If P(L) = 0.5
                                                            <br/>‚Üí P(L<sub>new</sub>) = 0.5 + (1 - 0.5) √ó 0.1 = 0.55
                                                            <br/><br/>
                                                            Interpretation: Mastery increases by learning rate, weighted by how much is left to learn
                                                        </div>
                                                    </div>
                                                    <div className="bg-red-500/20 p-4 rounded-lg border border-red-500/50">
                                                        <div className="font-bold mb-2">When Answer is INCORRECT:</div>
                                                        <div className="math-formula text-sm">
                                                            P(L<sub>n</sub>) = P(L<sub>n-1</sub>) √ó (1 - P(S))
                                                            <br/><br/>
                                                            Example: If P(L) = 0.5
                                                            <br/>‚Üí P(L<sub>new</sub>) = 0.5 √ó (1 - 0.1) = 0.45
                                                            <br/><br/>
                                                            Interpretation: Mastery decreases, accounting for possibility it was just a slip
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div>
                                                <h3 className="text-xl font-bold mb-3 text-pink-300">4. Full Bayesian Update (Advanced)</h3>
                                                <div className="math-formula text-sm">
                                                    P(L<sub>n</sub> | correct) = P(correct | L<sub>n</sub>) √ó P(L<sub>n</sub>) / P(correct)
                                                    <br/><br/>
                                                    Where:
                                                    <br/>‚Ä¢ P(correct | L<sub>n</sub>) = (1 - P(S)) if learned, P(G) if not
                                                    <br/>‚Ä¢ P(correct) = P(L<sub>n</sub>)(1 - P(S)) + (1 - P(L<sub>n</sub>))P(G)
                                                    <br/><br/>
                                                    This accounts for both guessing and slipping simultaneously.
                                                </div>
                                            </div>

                                            <div>
                                                <h3 className="text-xl font-bold mb-3 text-cyan-300">5. Implementation Notes</h3>
                                                <div className="bg-white/5 p-4 rounded-lg space-y-2 text-sm">
                                                    <div>
                                                        <span className="font-bold text-cyan-400">Current Implementation:</span> Simplified Bayesian update (formulas in section 3)
                                                    </div>
                                                    <div>
                                                        <span className="font-bold text-cyan-400">Data Storage:</span> Reviews saved to Firebase (bkt_reviews collection)
                                                    </div>
                                                    <div>
                                                        <span className="font-bold text-cyan-400">Advanced BKT:</span> For full pyBKT with learned parameters, export data and run train_bkt.py (requires 100+ reviews)
                                                    </div>
                                                    <div>
                                                        <span className="font-bold text-cyan-400">Skill Modeling:</span> Each flashcard deck treated as separate skill
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Current Data Stats */}
                                    <div className="bg-white/10 backdrop-blur rounded-2xl p-6 border border-white/20">
                                        <h2 className="text-2xl font-bold text-white mb-4">üìä Your BKT Data</h2>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div className="bg-white/5 p-4 rounded-lg">
                                                <div className="text-white/60 text-sm mb-1">Total Reviews</div>
                                                <div className="text-3xl font-bold text-white">{stats.totalReviews}</div>
                                                <div className="text-xs text-white/50 mt-2">
                                                    {stats.totalReviews >= 20 ? '‚úÖ Ready for BKT training' : `Need ${20 - stats.totalReviews} more for training`}
                                                </div>
                                            </div>
                                            <div className="bg-white/5 p-4 rounded-lg">
                                                <div className="text-white/60 text-sm mb-1">Tracked Skills</div>
                                                <div className="text-3xl font-bold text-white">{stats.totalSkills}</div>
                                                <div className="text-xs text-white/50 mt-2">
                                                    Avg {Math.round(stats.totalReviews / Math.max(1, stats.totalSkills))} reviews/skill
                                                </div>
                                            </div>
                                            <div className="bg-white/5 p-4 rounded-lg">
                                                <div className="text-white/60 text-sm mb-1">Model Status</div>
                                                <div className="text-xl font-bold text-white">Simplified BKT</div>
                                                <div className="text-xs text-white/50 mt-2">
                                                    Fixed parameters (not learned)
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Code Example */}
                                    <div className="bg-white/10 backdrop-blur rounded-2xl p-6 border border-white/20">
                                        <h2 className="text-2xl font-bold text-white mb-4">üíª Implementation Code</h2>
                                        <div className="math-formula text-sm">
                                            <pre className="text-white/90">
{`function updateMasteryScore(skill, correct) {
    // Current simplified BKT implementation
    const currentScore = getMasteryScore(skill);
    const learningRate = 0.1;  // P(T)
    const slipRate = 0.1;      // P(S)
    const guessRate = 0.2;     // P(G) - not used yet

    let newScore;
    if (correct) {
        // Learning update
        newScore = currentScore + (1 - currentScore) * learningRate;
    } else {
        // Slip penalty
        newScore = currentScore * (1 - slipRate);
    }

    // Constrain to [0, 1]
    return Math.max(0, Math.min(1, newScore));
}`}
                                            </pre>
                                        </div>
                                        <div className="mt-4 bg-yellow-500/20 border border-yellow-500/50 p-4 rounded-lg">
                                            <div className="font-bold text-yellow-400 mb-2">üöÄ Future Enhancement</div>
                                            <div className="text-sm text-white/80">
                                                For personalized P(T), P(S), and P(G) values per skill, collect 100+ reviews and run:
                                                <div className="math-formula mt-2 text-xs">
                                                    python export_firebase_bkt.py
                                                    <br/>python train_bkt.py
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<BKTAnalyticsApp />, document.getElementById('root'));
    </script>
    <!-- Dynamic Gradient System -->
    <script src="dynamic-gradient.js"></script>
</body>
</html>
