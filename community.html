<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Library - studying.works</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="global-styles.css">
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 " style="background: linear-gradient(to bottom right, #111827, #1e3a8a, #581c87); min-height: 100vh;">
    <script src="auth-guard.js"></script>
    <nav class="bg-black/30 backdrop-blur-lg border-b border-white/10 fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-8">
                    <a href="dashboard.html" class="text-2xl font-bold text-white flex items-center space-x-2">
                        <span>üéì</span>
                        <span>studying.works</span>
                    </a>
                    <div class="hidden md:flex space-x-4">
                        <a href="dashboard.html" class="text-white/80 hover:text-white hover:bg-white/10 px-3 py-2 rounded-lg transition-all">Dashboard</a>
                        <a href="community.html" class="text-white font-semibold px-3 py-2 rounded-lg bg-white/10">Community</a>
                        <a href="custom-flashcards.html" class="text-white/80 hover:text-white hover:bg-white/10 px-3 py-2 rounded-lg transition-all">My Flashcards</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div id="app" class="pt-20 p-4">
        <div class="max-w-7xl mx-auto page-container pt-20">
            <div class="text-center py-16">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-white mb-4"></div>
                <p class="text-white text-xl">Loading Community...</p>
            </div>
        </div>
    </div>

    <script>
        console.log('JavaScript is working! Page loaded.');
    </script>

    <script type="module">
        console.log('Module script started!');
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, updateDoc, increment } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        console.log('Firebase imports loaded!');

        const firebaseConfig = {
            apiKey: "AIzaSyD-2SELHboxELp2XLQIwstiI-pCaNcUDOA",
            authDomain: "academie-9942b.firebaseapp.com",
            projectId: "academie-9942b",
            storageBucket: "academie-9942b.firebasestorage.app",
            messagingSenderId: "1079518919325",
            appId: "1:1079518919325:web:745025bdb7b2b23645b274"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        console.log('Firebase initialized!', db);

        let currentView = 'browse';
        let allDecks = [];
        let previewDeck = null;
        const userId = localStorage.getItem('userId');
        const userName = localStorage.getItem('userName') || 'Anonymous';
        const userEmail = localStorage.getItem('userEmail') || '';
        
        // Admin whitelist
        const ADMIN_EMAILS = ['hocquetb@winchesterthurston.org'];
        const isAdmin = ADMIN_EMAILS.includes(userEmail);

        async function deleteCommunityDeck(deckId) {
            if (!isAdmin) {
                alert('Admin access required');
                return;
            }
            
            if (!confirm('Delete this community deck? This cannot be undone.')) return;
            
            try {
                await deleteDoc(doc(db, 'communityDecks', deckId));
                alert('Deck deleted successfully');
                await loadDecks();
            } catch (error) {
                alert('Error deleting deck: ' + error.message);
            }
        }
        
        window.deleteCommunityDeck = deleteCommunityDeck;

        async function loadDecks() {
            try {
                const q = query(collection(db, 'communityDecks'), orderBy('created', 'desc'));
                const snapshot = await getDocs(q);
                allDecks = [];
                snapshot.forEach(doc => {
                    allDecks.push({ id: doc.id, ...doc.data() });
                });
                renderView();
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('app').innerHTML = `
                    <div class="max-w-4xl mx-auto text-center py-16 bg-white/10 backdrop-blur rounded-2xl">
                        <div class="text-7xl mb-4">‚ö†Ô∏è</div>
                        <h2 class="text-3xl font-bold text-white mb-4">Error Loading Community</h2>
                        <p class="text-white/80 mb-4">${error.message}</p>
                        <p class="text-white/60">Make sure Firestore is enabled in Firebase Console</p>
                    </div>
                `;
            }
        }

        async function uploadDeck(title, subject, description, deckId) {
            try {
                const decks = JSON.parse(localStorage.getItem('flashcardDecks') || '[]');
                const deck = decks.find(d => d.id === parseInt(deckId));
                
                if (!deck) {
                    alert('Deck not found');
                    return;
                }

                const newDeck = {
                    title: title.trim(),
                    subject: subject.trim() || 'General',
                    description: description.trim() || 'No description',
                    author: userName,
                    authorEmail: userEmail,
                    authorId: userId,
                    cards: deck.cards.map(c => ({ question: c.question, answer: c.answer })),
                    downloads: 0,
                    created: new Date().toISOString()
                };

                await addDoc(collection(db, 'communityDecks'), newDeck);
                alert('Deck uploaded! üéâ');
                currentView = 'browse';
                await loadDecks();
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
            }
        }

        async function downloadDeck(deck) {
            try {
                const decks = JSON.parse(localStorage.getItem('flashcardDecks') || '[]');
                const newDeck = {
                    id: Date.now(),
                    title: `${deck.title} (from ${deck.author})`,
                    subject: deck.subject,
                    description: `Downloaded from ${deck.author}`,
                    cards: deck.cards.map(c => ({
                        id: Date.now() + Math.random(),
                        question: c.question,
                        answer: c.answer
                    })),
                    created: new Date().toISOString()
                };
                
                decks.push(newDeck);
                localStorage.setItem('flashcardDecks', JSON.stringify(decks));

                const deckRef = doc(db, 'communityDecks', deck.id);
                await updateDoc(deckRef, { downloads: increment(1) });

                alert(`Downloaded "${deck.title}"! Check "My Flashcards" to study.`);
                await loadDecks();
            } catch (error) {
                console.error('Download error:', error);
                alert('Download failed: ' + error.message);
            }
        }

        async function deleteDeck(deckId) {
            if (!confirm('Delete this deck?')) return;
            try {
                await deleteDoc(doc(db, 'communityDecks', deckId));
                alert('Deleted!');
                await loadDecks();
            } catch (error) {
                alert('Delete failed: ' + error.message);
            }
        }

        function renderView() {
            const app = document.getElementById('app');
            
            if (currentView === 'browse') {
                const myDecks = allDecks.filter(d => d.authorId === userId);
                app.innerHTML = `
                    <div class="max-w-7xl mx-auto page-container pt-20">
                        <div class="mb-8">
                            <h1 class="text-5xl font-bold text-white mb-2">üåç Community Library</h1>
                            <p class="text-xl text-blue-200">Discover and share flashcard decks</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <button id="upload-btn" class="bg-gradient-to-r from-green-500 to-teal-500 text-white p-6 rounded-2xl font-bold hover:shadow-2xl transform hover:scale-105 transition-all">
                                <div class="text-5xl mb-2">üì§</div>
                                Upload Your Deck
                            </button>
                            <button id="mydecks-btn" class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white p-6 rounded-2xl font-bold hover:shadow-2xl transform hover:scale-105 transition-all">
                                <div class="text-5xl mb-2">üìö</div>
                                My Uploads (${myDecks.length})
                            </button>
                            <a href="custom-flashcards.html" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6 rounded-2xl font-bold hover:shadow-2xl transform hover:scale-105 transition-all text-center">
                                <div class="text-5xl mb-2">üé¥</div>
                                My Flashcards
                            </a>
                        </div>

                        ${allDecks.length === 0 ? `
                            <div class="text-center py-16 bg-white/10 backdrop-blur rounded-2xl">
                                <div class="text-7xl mb-4">üìö</div>
                                <p class="text-white text-xl mb-4">No decks yet</p>
                                <button onclick="window.currentView='upload';window.renderView()" class="bg-blue-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600">
                                    Upload First Deck
                                </button>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${allDecks.map(deck => `
                                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 hover:transform hover:scale-105 transition-all">
                                        <div class="flex items-start justify-between mb-4">
                                            <h3 class="text-2xl font-bold text-white">${deck.title}</h3>
                                            <span class="bg-blue-500 text-white px-3 py-1 rounded-full text-xs font-bold">${deck.subject}</span>
                                        </div>
                                        <p class="text-white/80 mb-4">${deck.description.substring(0, 100)}...</p>
                                        <div class="text-white/60 text-sm mb-4">
                                            üë§ ${deck.author}<br>
                                            üé¥ ${deck.cards.length} cards ‚Ä¢ üì• ${deck.downloads} downloads
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="window.downloadDeck(${JSON.stringify(deck).replace(/"/g, '&quot;')})" class="flex-1 bg-gradient-to-r from-green-500 to-teal-500 text-white px-4 py-2 rounded-xl font-semibold hover:shadow-lg transition-all">
                                                üì• Download
                                            </button>
                                            ${isAdmin ? `
                                                <button onclick="window.deleteCommunityDeck('${deck.id}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-semibold transition-all">
                                                    üóëÔ∏è
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                `;
                
                // Add event listeners
                const uploadBtn = document.getElementById('upload-btn');
                const mydecksBtn = document.getElementById('mydecks-btn');
                console.log('Upload button:', uploadBtn);
                console.log('Mydecks button:', mydecksBtn);
                if (uploadBtn) {
                    uploadBtn.onclick = () => { 
                        console.log('Upload button clicked!');
                        currentView = 'upload'; 
                        renderView(); 
                    };
                }
                if (mydecksBtn) {
                    mydecksBtn.onclick = () => { 
                        console.log('Mydecks button clicked!');
                        currentView = 'mydecks'; 
                        renderView(); 
                    };
                }
                
            } else if (currentView === 'upload') {
                const localDecks = JSON.parse(localStorage.getItem('flashcardDecks') || '[]');
                app.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <button id="back-btn" class="mb-6 bg-white/20 text-white px-6 py-3 rounded-xl font-semibold">
                            ‚Üê Back
                        </button>

                        <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-8 border border-white/20">
                            <h2 class="text-4xl font-bold text-white mb-6">üì§ Upload Deck</h2>
                            
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-white font-bold mb-2">Deck Title *</label>
                                    <input id="upload-title" type="text" placeholder="e.g., Biology Quiz 2" class="w-full px-4 py-3 rounded-xl bg-white/90 text-gray-800 font-semibold">
                                </div>
                                <div>
                                    <label class="block text-white font-bold mb-2">Subject</label>
                                    <input id="upload-subject" type="text" placeholder="e.g., Biology" class="w-full px-4 py-3 rounded-xl bg-white/90 text-gray-800 font-semibold">
                                </div>
                                <div>
                                    <label class="block text-white font-bold mb-2">Description</label>
                                    <textarea id="upload-description" rows="3" placeholder="Describe your deck..." class="w-full px-4 py-3 rounded-xl bg-white/90 text-gray-800 font-semibold"></textarea>
                                </div>
                                <div>
                                    <label class="block text-white font-bold mb-2">Select Deck *</label>
                                    <select id="upload-deck" class="w-full px-4 py-3 rounded-xl bg-white/90 text-gray-800 font-semibold">
                                        <option value="">Choose a deck...</option>
                                        ${localDecks.map(d => `<option value="${d.id}">${d.title} (${d.cards.length} cards)</option>`).join('')}
                                    </select>
                                    ${localDecks.length === 0 ? '<p class="text-white/60 text-sm mt-2">No decks found. <a href="custom-flashcards.html" class="text-blue-300 underline">Create one first</a></p>' : ''}
                                </div>
                                <div class="bg-yellow-500/20 border border-yellow-500 rounded-xl p-4">
                                    <p class="text-white text-sm">Your name (${userName}) will be attached to this deck.</p>
                                </div>
                                <button onclick="window.handleUpload()" class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white py-4 rounded-xl font-bold text-xl hover:shadow-2xl">
                                    üì§ Upload to Community
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners
                const backBtn = document.getElementById('back-btn');
                if (backBtn) backBtn.onclick = () => { currentView = 'browse'; renderView(); };
                
            } else if (currentView === 'mydecks') {
                const myDecks = allDecks.filter(d => d.authorId === userId);
                app.innerHTML = `
                    <div class="max-w-7xl mx-auto page-container pt-20">
                        <button id="back-btn-mydecks" class="mb-6 bg-white/20 text-white px-6 py-3 rounded-xl font-semibold">
                            ‚Üê Back
                        </button>
                        <div class="mb-8">
                            <h2 class="text-4xl font-bold text-white mb-2">üìö My Uploaded Decks</h2>
                        </div>
                        ${myDecks.length === 0 ? `
                            <div class="text-center py-16 bg-white/10 backdrop-blur rounded-2xl">
                                <div class="text-7xl mb-4">üì§</div>
                                <p class="text-white text-xl mb-4">You haven't uploaded any decks yet</p>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${myDecks.map(deck => `
                                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                                        <div class="flex items-start justify-between mb-4">
                                            <h3 class="text-2xl font-bold text-white">${deck.title}</h3>
                                            <span class="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold">YOURS</span>
                                        </div>
                                        <p class="text-white/80 mb-4">${deck.description}</p>
                                        <div class="text-white/60 text-sm mb-4">
                                            üé¥ ${deck.cards.length} cards ‚Ä¢ üì• ${deck.downloads} downloads
                                        </div>
                                        <button onclick="window.deleteDeck('${deck.id}')" class="w-full bg-red-500 text-white px-4 py-2 rounded-xl font-semibold hover:bg-red-600">
                                            üóëÔ∏è Delete
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                `;
                
                // Add event listener
                const backBtn = document.getElementById('back-btn-mydecks');
                if (backBtn) backBtn.onclick = () => { currentView = 'browse'; renderView(); };
            }
        }

        window.currentView = currentView;
        window.renderView = renderView;
        window.downloadDeck = downloadDeck;
        window.deleteDeck = deleteDeck;
        window.handleUpload = async function() {
            const title = document.getElementById('upload-title').value;
            const subject = document.getElementById('upload-subject').value;
            const description = document.getElementById('upload-description').value;
            const deckId = document.getElementById('upload-deck').value;
            
            if (!title.trim() || !deckId) {
                alert('Please fill in title and select a deck');
                return;
            }
            
            await uploadDeck(title, subject, description, deckId);
        };

        loadDecks();
    </script>
</body>
</html>