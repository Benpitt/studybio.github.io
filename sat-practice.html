<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAT Practice - Studying Works</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="learning-profile-utils.js"></script>
    <script src="tts-button.js"></script>
    <script src="sat-irt-model.js"></script>
    <script src="sat-reinforcement-learning.js"></script>
    <script src="sat-firebase-sync.js"></script>
    <script src="https://www.desmos.com/api/v1.9/calculator.js?apiKey=afe7c31454144b64b28246771a567788"></script>
    <!-- MathJax for math rendering (MathML + LaTeX support) -->
    <script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        svg: {
            fontCache: 'global'
        },
        startup: {
            ready: () => {
                MathJax.startup.defaultReady();
                console.log('MathJax loaded and ready');
            }
        }
    };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
    <!-- DOMPurify for HTML sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="apple-style.css">
    <link rel="stylesheet" href="global-styles.css">
    <link rel="stylesheet" href="button-styles.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }

        .draggable-widget {
            position: fixed;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: move;
        }

        .draggable-widget.dragging {
            opacity: 0.8;
            cursor: grabbing;
        }

        .widget-header {
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px 8px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 14px;
        }

        .widget-content {
            padding: 12px;
        }

        .desmos-container {
            width: 100%;
            height: 400px;
            border-radius: 4px;
        }

        .question-panel {
            background: white;
            padding: 32px;
            min-height: calc(100vh - 64px);
        }

        .answer-panel {
            background: #fafafa;
            padding: 32px;
            min-height: calc(100vh - 64px);
        }

        .choice-option {
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .choice-option:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .choice-option.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .choice-option.correct {
            border-color: #10b981;
            background: #d1fae5;
        }

        .choice-option.incorrect {
            border-color: #ef4444;
            background: #fee2e2;
        }

        .topic-card {
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .topic-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .topic-card.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .widget-toggle {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .widget-toggle:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .widget-toggle.active {
            border-color: #667eea;
            background: #eef2ff;
            color: #667eea;
        }

        .question-id {
            font-family: monospace;
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-main">Skip to main content</a>
    <script type="module" src="auth-guard.js"></script>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD-2SELHboxELp2XLQIwstiI-pCaNcUDOA",
            authDomain: "academie-9942b.firebaseapp.com",
            projectId: "academie-9942b",
            storageBucket: "academie-9942b.firebasestorage.app",
            messagingSenderId: "1079518919325",
            appId: "1:1079518919325:web:745025bdb7b2b23645b274"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Initialize Firebase sync
        const satSync = initializeSATFirebaseSync(db, auth);

        // Math rendering utility with HTML and MathML support
        function MathText({ text, className = "" }) {
            const containerRef = useRef(null);

            useEffect(() => {
                if (containerRef.current && text) {
                    try {
                        // Sanitize HTML content with DOMPurify, allowing MathML tags
                        const cleanHTML = window.DOMPurify ? window.DOMPurify.sanitize(text, {
                            ALLOWED_TAGS: ['p', 'span', 'div', 'br', 'strong', 'em', 'u', 'sub', 'sup', 'img', 'table', 'tr', 'td', 'th', 'ul', 'ol', 'li',
                                          'math', 'mi', 'mn', 'mo', 'mrow', 'mfrac', 'msup', 'msub', 'msubsup', 'msqrt', 'mroot',
                                          'mfenced', 'mtable', 'mtr', 'mtd', 'mstyle', 'mtext', 'mspace', 'menclose', 'mover', 'munder', 'munderover'],
                            ALLOWED_ATTR: ['class', 'style', 'src', 'alt', 'width', 'height', 'alttext', 'displaystyle', 'mathvariant', 'href'],
                            ALLOW_DATA_ATTR: false,
                            ADD_ATTR: ['alttext', 'displaystyle']
                        }) : text;

                        // Set the sanitized HTML
                        containerRef.current.innerHTML = cleanHTML;

                        // Typeset math using MathJax after HTML is set
                        if (window.MathJax && window.MathJax.typesetPromise) {
                            window.MathJax.typesetPromise([containerRef.current]).catch((err) => {
                                console.warn('MathJax typesetting error:', err);
                            });
                        }
                    } catch (error) {
                        console.error('Error rendering math/HTML:', error);
                        containerRef.current.textContent = text;
                    }
                }
            }, [text]);

            return <div ref={containerRef} className={className}></div>;
        }

        function Navigation() {
            const [userName, setUserName] = useState('Student');
            const [userEmail, setUserEmail] = useState('');
            const [userPhoto, setUserPhoto] = useState('https://via.placeholder.com/40');

            useEffect(() => {
                // Load user info from localStorage
                const name = localStorage.getItem('userName') || 'Student';
                const email = localStorage.getItem('userEmail') || '';
                const photo = localStorage.getItem('userPhoto') || 'https://via.placeholder.com/40';

                setUserName(name);
                setUserEmail(email);
                setUserPhoto(photo);
            }, []);

            const handleSignOut = () => {
                localStorage.clear();
                window.location.href = 'index.html';
            };

            return (
                <nav className="bg-black/30 backdrop-blur-lg border-b border-white/10 sticky top-0 z-50">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex items-center justify-between h-16">
                            <div className="flex items-center space-x-8">
                                <a href="dashboard" className="text-xl font-bold text-white flex items-center space-x-2 hover:scale-105 transition-transform">
                                    <span>üéì</span>
                                    <span>studying.works</span>
                                </a>
                                <div className="hidden md:flex space-x-4">
                                    <a href="dashboard" className="text-white/80 hover:text-white hover:bg-white/10 px-3 py-2 rounded-lg transition-all">Dashboard</a>
                                    <a href="sat-practice" className="text-white font-semibold px-3 py-2 rounded-lg bg-white/10">SAT Practice</a>
                                    <a href="custom-flashcards" className="text-white/80 hover:text-white hover:bg-white/10 px-3 py-2 rounded-lg transition-all">Flashcards</a>
                                    <a href="progress" className="text-white/80 hover:text-white hover:bg-white/10 px-3 py-2 rounded-lg transition-all">Progress</a>
                                </div>
                            </div>
                            <div className="flex items-center space-x-4">
                                <div className="relative group">
                                    <button className="flex items-center space-x-3 bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full transition-all">
                                        <img src={userPhoto} alt="User profile" className="w-8 h-8 rounded-full" loading="lazy" />
                                        <span className="text-white font-semibold hidden md:block">{userName.split(' ')[0]}</span>
                                    </button>
                                    <div className="absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all">
                                        <div className="p-4">
                                            <p className="text-sm text-gray-600 mb-3 break-words">{userEmail}</p>
                                            <button
                                                onClick={handleSignOut}
                                                className="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-all"
                                            >
                                                Sign Out
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
            );
        }

        function Breadcrumb({ items }) {
            return (
                <div className="bg-black/20 backdrop-blur-sm border-b border-white/5" style={{ position: 'sticky', top: '64px', zIndex: 40 }}>
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                        <nav className="flex items-center space-x-2 text-sm">
                            {items.map((item, index) => (
                                <React.Fragment key={index}>
                                    {index > 0 && (
                                        <svg className="w-4 h-4 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                        </svg>
                                    )}
                                    {item.href ? (
                                        <a
                                            href={item.href}
                                            className="text-white/60 hover:text-white transition-colors"
                                        >
                                            {item.label}
                                        </a>
                                    ) : (
                                        <span className="text-white font-medium">{item.label}</span>
                                    )}
                                </React.Fragment>
                            ))}
                        </nav>
                    </div>
                </div>
            );
        }

        function DraggableWidget({ title, children, initialX, initialY, initialWidth, initialHeight, onClose }) {
            const [position, setPosition] = useState({ x: initialX, y: initialY });
            const [size, setSize] = useState({ width: initialWidth || 450, height: initialHeight || 500 });
            const [isDragging, setIsDragging] = useState(false);
            const [isResizing, setIsResizing] = useState(false);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            const [resizeStart, setResizeStart] = useState({ x: 0, y: 0, width: 0, height: 0 });
            const widgetRef = useRef(null);

            const handleMouseDown = (e) => {
                if (e.target.closest('.widget-header')) {
                    setIsDragging(true);
                    const rect = widgetRef.current.getBoundingClientRect();
                    setDragOffset({
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    });
                }
            };

            const handleResizeMouseDown = (e) => {
                e.stopPropagation();
                setIsResizing(true);
                setResizeStart({
                    x: e.clientX,
                    y: e.clientY,
                    width: size.width,
                    height: size.height
                });
            };

            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (isDragging) {
                        setPosition({
                            x: e.clientX - dragOffset.x,
                            y: e.clientY - dragOffset.y
                        });
                    } else if (isResizing) {
                        const deltaX = e.clientX - resizeStart.x;
                        const deltaY = e.clientY - resizeStart.y;
                        setSize({
                            width: Math.max(300, resizeStart.width + deltaX),
                            height: Math.max(300, resizeStart.height + deltaY)
                        });
                    }
                };

                const handleMouseUp = () => {
                    setIsDragging(false);
                    setIsResizing(false);
                };

                if (isDragging || isResizing) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                }

                return () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
            }, [isDragging, isResizing, dragOffset, resizeStart]);

            return (
                <div
                    ref={widgetRef}
                    className={`draggable-widget ${isDragging ? 'dragging' : ''}`}
                    style={{
                        left: `${position.x}px`,
                        top: `${position.y}px`,
                        width: `${size.width}px`,
                        height: `${size.height}px`
                    }}
                    onMouseDown={handleMouseDown}
                >
                    <div className="widget-header">
                        <span>{title}</span>
                        <button onClick={onClose} className="text-white hover:text-gray-200 font-bold text-lg bg-white/20 hover:bg-white/30 px-2 rounded transition-all">√ó</button>
                    </div>
                    <div className="widget-content" style={{ height: 'calc(100% - 40px)', overflow: 'hidden' }}>
                        {children}
                    </div>
                    <div
                        onMouseDown={handleResizeMouseDown}
                        style={{
                            position: 'absolute',
                            right: 0,
                            bottom: 0,
                            width: '20px',
                            height: '20px',
                            cursor: 'nwse-resize',
                            background: 'linear-gradient(135deg, transparent 0%, transparent 50%, rgba(102, 126, 234, 0.5) 50%, rgba(102, 126, 234, 0.8) 100%)',
                            borderRadius: '0 0 8px 0'
                        }}
                    />
                </div>
            );
        }

        function DesmosCalculator({ mode }) {
            const calculatorRef = useRef(null);
            const containerRef = useRef(null);

            useEffect(() => {
                if (containerRef.current && !calculatorRef.current) {
                    calculatorRef.current = Desmos.GraphingCalculator(containerRef.current, {
                        keypad: true,
                        expressions: mode === 'graphing',
                        graphpaper: mode === 'graphing',
                        settingsMenu: true,
                        expressionsTopbar: mode === 'graphing'
                    });
                }

                return () => {
                    if (calculatorRef.current) {
                        calculatorRef.current.destroy();
                        calculatorRef.current = null;
                    }
                };
            }, [mode]);

            return <div ref={containerRef} style={{ width: '100%', height: '100%' }} />;
        }

        function HomeScreen({ onNavigate }) {
            return (
                <div id="main-content" className="max-w-6xl mx-auto py-12 px-6">
                    {/* Welcome Header */}
                    <div className="text-center mb-12">
                        <h1 className="text-5xl font-black mb-4 bg-gradient-to-r from-purple-600 via-blue-500 to-indigo-600 bg-clip-text text-transparent">
                            SAT Digital Practice
                        </h1>
                        <p className="text-xl text-white/80">
                            Master your SAT preparation with comprehensive practice and insights
                        </p>
                    </div>

                    {/* Main Navigation Cards */}
                    <div className="grid md:grid-cols-2 gap-6 mb-12">
                        {/* Question Bank Card */}
                        <div
                            onClick={() => onNavigate('questionBank')}
                            className="group bg-white/10 backdrop-blur-md border-2 border-white/20 rounded-2xl p-8 cursor-pointer transition-all duration-300 hover:bg-white/20 hover:border-white/40 hover:scale-105 hover:shadow-2xl"
                        >
                            <div className="text-6xl mb-4">üìö</div>
                            <h2 className="text-3xl font-bold text-white mb-3">Question Bank</h2>
                            <p className="text-white/70 mb-4">
                                Practice with real Digital SAT questions across all subjects and difficulty levels
                            </p>
                            <div className="flex items-center text-white/60 group-hover:text-white transition-colors">
                                <span className="font-semibold">Start Practice</span>
                                <svg className="w-5 h-5 ml-2 group-hover:translate-x-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                </svg>
                            </div>
                        </div>

                        {/* Stats Card */}
                        <div
                            onClick={() => onNavigate('stats')}
                            className="group bg-white/10 backdrop-blur-md border-2 border-white/20 rounded-2xl p-8 cursor-pointer transition-all duration-300 hover:bg-white/20 hover:border-white/40 hover:scale-105 hover:shadow-2xl"
                        >
                            <div className="text-6xl mb-4">üìä</div>
                            <h2 className="text-3xl font-bold text-white mb-3">Stats & Analytics</h2>
                            <p className="text-white/70 mb-4">
                                Track your progress, view detailed statistics, and identify areas for improvement
                            </p>
                            <div className="flex items-center text-white/60 group-hover:text-white transition-colors">
                                <span className="font-semibold">View Stats</span>
                                <svg className="w-5 h-5 ml-2 group-hover:translate-x-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                </svg>
                            </div>
                        </div>
                    </div>

                    {/* Widgets Section */}
                    <div className="bg-white/10 backdrop-blur-md border-2 border-white/20 rounded-2xl p-8">
                        <h2 className="text-2xl font-bold text-white mb-6 flex items-center">
                            <span className="mr-3">‚ö°</span>
                            Quick Insights
                        </h2>
                        <div className="grid md:grid-cols-3 gap-6">
                            {/* Widget Placeholder 1 - Study Streak */}
                            <div className="bg-white/5 border border-white/10 rounded-xl p-6 hover:bg-white/10 transition-all">
                                <div className="flex items-center justify-between mb-4">
                                    <span className="text-3xl">üî•</span>
                                    <span className="text-xs font-semibold text-white/50 bg-white/10 px-2 py-1 rounded">COMING SOON</span>
                                </div>
                                <h3 className="text-lg font-bold text-white mb-2">Study Streak</h3>
                                <p className="text-3xl font-black text-white/80 mb-1">‚Äî</p>
                                <p className="text-sm text-white/60">days in a row</p>
                            </div>

                            {/* Widget Placeholder 2 - Recent Performance */}
                            <div className="bg-white/5 border border-white/10 rounded-xl p-6 hover:bg-white/10 transition-all">
                                <div className="flex items-center justify-between mb-4">
                                    <span className="text-3xl">üéØ</span>
                                    <span className="text-xs font-semibold text-white/50 bg-white/10 px-2 py-1 rounded">COMING SOON</span>
                                </div>
                                <h3 className="text-lg font-bold text-white mb-2">Recent Accuracy</h3>
                                <p className="text-3xl font-black text-white/80 mb-1">‚Äî</p>
                                <p className="text-sm text-white/60">last 10 questions</p>
                            </div>

                            {/* Widget Placeholder 3 - Total Progress */}
                            <div className="bg-white/5 border border-white/10 rounded-xl p-6 hover:bg-white/10 transition-all">
                                <div className="flex items-center justify-between mb-4">
                                    <span className="text-3xl">üìà</span>
                                    <span className="text-xs font-semibold text-white/50 bg-white/10 px-2 py-1 rounded">COMING SOON</span>
                                </div>
                                <h3 className="text-lg font-bold text-white mb-2">Total Questions</h3>
                                <p className="text-3xl font-black text-white/80 mb-1">‚Äî</p>
                                <p className="text-sm text-white/60">completed so far</p>
                            </div>
                        </div>
                    </div>

                    {/* Additional Widgets Row */}
                    <div className="grid md:grid-cols-2 gap-6 mt-6">
                        {/* Widget Placeholder 4 - Strengths & Weaknesses */}
                        <div className="bg-white/10 backdrop-blur-md border-2 border-white/20 rounded-2xl p-8">
                            <div className="flex items-center justify-between mb-6">
                                <h3 className="text-xl font-bold text-white flex items-center">
                                    <span className="mr-3">üí™</span>
                                    Strengths & Weaknesses
                                </h3>
                                <span className="text-xs font-semibold text-white/50 bg-white/10 px-3 py-1 rounded-full">COMING SOON</span>
                            </div>
                            <div className="space-y-3">
                                <div className="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                    <span className="text-white/60">Top performing area</span>
                                    <span className="text-white/40">‚Äî</span>
                                </div>
                                <div className="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                    <span className="text-white/60">Needs improvement</span>
                                    <span className="text-white/40">‚Äî</span>
                                </div>
                            </div>
                        </div>

                        {/* Widget Placeholder 5 - Recommended Practice */}
                        <div className="bg-white/10 backdrop-blur-md border-2 border-white/20 rounded-2xl p-8">
                            <div className="flex items-center justify-between mb-6">
                                <h3 className="text-xl font-bold text-white flex items-center">
                                    <span className="mr-3">üéì</span>
                                    Recommended Practice
                                </h3>
                                <span className="text-xs font-semibold text-white/50 bg-white/10 px-3 py-1 rounded-full">COMING SOON</span>
                            </div>
                            <div className="text-center py-8">
                                <div className="text-5xl mb-3">üîç</div>
                                <p className="text-white/60">We'll suggest topics to practice based on your performance</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function StatsScreen({ onBack }) {
            // Redirect to the full analytics page
            useEffect(() => {
                window.location.href = 'sat-analytics.html';
            }, []);

            return (
                <div id="main-content" className="max-w-6xl mx-auto py-12 px-6">
                    <div className="text-center">
                        <div className="text-6xl mb-4">üìä</div>
                        <p className="text-xl text-white/80">Redirecting to Analytics...</p>
                    </div>
                </div>
            );
        }

        function TopicSelectionMenu({ onStartTest, allQuestions, onBack }) {
            const [step, setStep] = useState(1); // 1: disciplines, 2: filters
            const [selectedModule, setSelectedModule] = useState('math'); // 'math' or 'english'
            const [selectedDisciplines, setSelectedDisciplines] = useState([]);
            const [selectedDifficulties, setSelectedDifficulties] = useState(['E', 'M', 'H']); // All by default
            const [customCount, setCustomCount] = useState(10);
            const [smartSelection, setSmartSelection] = useState(true); // Enable AI recommendations by default

            // Define disciplines by module
            const mathDisciplines = [
                { id: 'Algebra', name: 'Algebra', icon: 'üìê' },
                { id: 'Advanced Math', name: 'Advanced Math', icon: 'üî¢' },
                { id: 'Problem-Solving and Data Analysis', name: 'Problem-Solving & Data Analysis', icon: 'üìä' },
                { id: 'Geometry and Trigonometry', name: 'Geometry & Trigonometry', icon: 'üî∫' }
            ];

            const englishDisciplines = [
                { id: 'Information and Ideas', name: 'Information & Ideas', icon: 'üí°' },
                { id: 'Craft and Structure', name: 'Craft & Structure', icon: 'üèóÔ∏è' },
                { id: 'Expression of Ideas', name: 'Expression of Ideas', icon: '‚úçÔ∏è' },
                { id: 'Standard English Conventions', name: 'Standard English Conventions', icon: 'üìñ' }
            ];

            const difficulties = [
                { id: 'E', name: 'Easy', icon: 'üü¢', color: 'bg-green-100 border-green-500' },
                { id: 'M', name: 'Medium', icon: 'üü°', color: 'bg-yellow-100 border-yellow-500' },
                { id: 'H', name: 'Hard', icon: 'üî¥', color: 'bg-red-100 border-red-500' }
            ];

            const currentDisciplines = selectedModule === 'math' ? mathDisciplines : englishDisciplines;

            // Count questions per discipline
            const getDisciplineCount = (disciplineId) => {
                return allQuestions.filter(q => q.module === selectedModule && q.domain === disciplineId).length;
            };

            // Count questions with current filters
            const getFilteredCount = () => {
                return allQuestions.filter(q =>
                    q.module === selectedModule &&
                    selectedDisciplines.includes(q.domain) &&
                    selectedDifficulties.includes(q.difficulty)
                ).length;
            };

            const toggleDiscipline = (disciplineId) => {
                setSelectedDisciplines(prev =>
                    prev.includes(disciplineId)
                        ? prev.filter(id => id !== disciplineId)
                        : [...prev, disciplineId]
                );
            };

            const toggleDifficulty = (difficultyId) => {
                setSelectedDifficulties(prev =>
                    prev.includes(difficultyId)
                        ? prev.filter(id => id !== difficultyId)
                        : [...prev, difficultyId]
                );
            };

            // When switching modules, clear selected disciplines
            const handleModuleChange = (module) => {
                setSelectedModule(module);
                setSelectedDisciplines([]);
                setStep(1);
            };

            return (
                <div id="main-content" className="max-w-5xl mx-auto py-12 px-6">
                    <button
                        onClick={onBack}
                        className="mb-8 text-white/80 hover:text-white font-semibold flex items-center transition-all group"
                    >
                        <svg className="w-5 h-5 mr-2 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                        </svg>
                        Back to Home
                    </button>

                    <div className="bg-white rounded-xl shadow-lg p-8">
                        <h1 className="text-3xl font-bold mb-2 bg-gradient-to-r from-purple-600 to-blue-500 bg-clip-text text-transparent">
                            SAT Digital Practice
                        </h1>
                        <p className="text-gray-600 mb-8">
                            {step === 1 ? 'Select module and disciplines' : 'Customize your practice session'}
                        </p>

                        {/* Progress Indicator */}
                        <div className="flex items-center justify-center mb-8">
                            <div className="flex items-center space-x-2">
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${
                                    step >= 1 ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-500'
                                }`}>1</div>
                                <div className={`w-16 h-1 ${step >= 2 ? 'bg-purple-600' : 'bg-gray-200'}`}></div>
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${
                                    step >= 2 ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-500'
                                }`}>2</div>
                            </div>
                        </div>

                        {step === 1 && (
                            <>
                                {/* Module Selector */}
                                <div className="mb-8">
                                    <h2 className="text-xl font-bold mb-4 text-gray-800">Select Module</h2>
                                    <div className="grid grid-cols-2 gap-4">
                                        <button
                                            onClick={() => handleModuleChange('math')}
                                            className={`p-6 rounded-xl border-2 transition-all ${
                                                selectedModule === 'math'
                                                    ? 'border-purple-600 bg-purple-50'
                                                    : 'border-gray-300 hover:border-purple-400'
                                            }`}
                                        >
                                            <div className="text-4xl mb-2">üî¢</div>
                                            <div className="font-bold text-xl text-gray-800">Math</div>
                                            <div className="text-sm text-gray-600">
                                                {allQuestions.filter(q => q.module === 'math').length} questions
                                            </div>
                                        </button>
                                        <button
                                            onClick={() => handleModuleChange('english')}
                                            className={`p-6 rounded-xl border-2 transition-all ${
                                                selectedModule === 'english'
                                                    ? 'border-purple-600 bg-purple-50'
                                                    : 'border-gray-300 hover:border-purple-400'
                                            }`}
                                        >
                                            <div className="text-4xl mb-2">üìö</div>
                                            <div className="font-bold text-xl text-gray-800">Reading & Writing</div>
                                            <div className="text-sm text-gray-600">
                                                {allQuestions.filter(q => q.module === 'english').length} questions
                                            </div>
                                        </button>
                                    </div>
                                </div>

                                {/* Discipline Selector */}
                                <div className="mb-8">
                                    <h2 className="text-xl font-bold mb-4 text-gray-800">
                                        Select {selectedModule === 'math' ? 'Math' : 'Reading & Writing'} Disciplines
                                    </h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {currentDisciplines.map(discipline => {
                                            const count = getDisciplineCount(discipline.id);
                                            return (
                                                <div
                                                    key={discipline.id}
                                                    onClick={() => toggleDiscipline(discipline.id)}
                                                    className={`topic-card ${selectedDisciplines.includes(discipline.id) ? 'selected' : ''}`}
                                                >
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center space-x-3">
                                                            <span className="text-3xl">{discipline.icon}</span>
                                                            <div>
                                                                <div className="font-bold text-gray-800">{discipline.name}</div>
                                                                <div className="text-sm text-gray-500">{count} questions</div>
                                                            </div>
                                                        </div>
                                                        <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                                                            selectedDisciplines.includes(discipline.id)
                                                                ? 'bg-purple-600 border-purple-600'
                                                                : 'border-gray-300'
                                                        }`}>
                                                            {selectedDisciplines.includes(discipline.id) && (
                                                                <span className="text-white text-sm">‚úì</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                <button
                                    onClick={() => setStep(2)}
                                    disabled={selectedDisciplines.length === 0}
                                    className="w-full px-6 py-4 bg-gradient-to-r from-purple-600 to-blue-500 text-white rounded-lg font-bold text-lg hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Continue to Filters ‚Üí
                                </button>
                            </>
                        )}

                        {step === 2 && (
                            <>
                                {/* Difficulty Selector */}
                                <div className="mb-8">
                                    <h2 className="text-xl font-bold mb-4 text-gray-800">Select Difficulty Levels</h2>
                                    <div className="grid grid-cols-3 gap-4">
                                        {difficulties.map(difficulty => (
                                            <div
                                                key={difficulty.id}
                                                onClick={() => toggleDifficulty(difficulty.id)}
                                                className={`p-6 rounded-xl border-2 cursor-pointer transition-all ${
                                                    selectedDifficulties.includes(difficulty.id)
                                                        ? `${difficulty.color} border-2`
                                                        : 'border-gray-300 hover:border-gray-400'
                                                }`}
                                            >
                                                <div className="text-center">
                                                    <div className="text-3xl mb-2">{difficulty.icon}</div>
                                                    <div className="font-bold text-gray-800">{difficulty.name}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Number of Questions */}
                                <div className="mb-8">
                                    <label className="block text-lg font-bold mb-3 text-gray-800">Number of Questions</label>
                                    <input
                                        type="number"
                                        min="1"
                                        max="50"
                                        value={customCount}
                                        onChange={(e) => setCustomCount(parseInt(e.target.value) || 10)}
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-lg"
                                    />
                                    <div className="mt-2 text-sm text-gray-600">
                                        {getFilteredCount()} questions available with current filters
                                    </div>
                                </div>

                                {/* Smart Selection Toggle */}
                                <div className="mb-8 p-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl border-2 border-purple-200">
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="flex items-center gap-3">
                                            <span className="text-2xl">ü§ñ</span>
                                            <div>
                                                <h3 className="font-bold text-gray-800">AI-Powered Question Selection</h3>
                                                <p className="text-sm text-gray-600">Let our reinforcement learning algorithm target your weaknesses</p>
                                            </div>
                                        </div>
                                        <label className="relative inline-flex items-center cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={smartSelection}
                                                onChange={(e) => setSmartSelection(e.target.checked)}
                                                className="sr-only peer"
                                            />
                                            <div className="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-purple-600"></div>
                                        </label>
                                    </div>
                                    {smartSelection ? (
                                        <div className="text-sm text-gray-700 bg-white/70 rounded-lg p-3">
                                            <span className="font-semibold text-purple-600">‚úì Enabled:</span> Questions will be selected using Thompson Sampling to focus on your weakest domains and optimal difficulty levels.
                                        </div>
                                    ) : (
                                        <div className="text-sm text-gray-700 bg-white/70 rounded-lg p-3">
                                            <span className="font-semibold text-gray-600">Random:</span> Questions will be randomly selected from your chosen filters.
                                        </div>
                                    )}
                                </div>

                                <div className="flex gap-4">
                                    <button
                                        onClick={() => setStep(1)}
                                        className="flex-1 px-6 py-4 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-bold text-lg transition-all"
                                    >
                                        ‚Üê Back
                                    </button>
                                    <button
                                        onClick={() => onStartTest({
                                            module: selectedModule,
                                            disciplines: selectedDisciplines,
                                            difficulties: selectedDifficulties,
                                            count: customCount,
                                            smartSelection: smartSelection
                                        })}
                                        disabled={selectedDifficulties.length === 0}
                                        className="flex-1 px-6 py-4 bg-gradient-to-r from-purple-600 to-blue-500 text-white rounded-lg font-bold text-lg hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {smartSelection ? 'ü§ñ Start AI-Powered Practice' : 'üé≤ Start Practice Test'}
                                    </button>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        function SATApp() {
            const [mode, setMode] = useState('home'); // 'home', 'menu', 'test', 'stats'
            const [allQuestions, setAllQuestions] = useState([]); // Full question bank
            const [testQuestions, setTestQuestions] = useState([]); // Current test questions
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [userAnswers, setUserAnswers] = useState({});
            const [isSubmitted, setIsSubmitted] = useState(false);
            const [showCalculator, setShowCalculator] = useState(false);
            const [calculatorMode, setCalculatorMode] = useState('graphing');
            const [questionStartTime, setQuestionStartTime] = useState(Date.now());

            // Initialize RL model and Firebase sync when component mounts
            useEffect(() => {
                if (typeof initializeSATRL === 'function') {
                    initializeSATRL();
                }

                // Load data from Firebase and enable auto-sync
                if (satSync) {
                    satSync.loadAll().then(() => {
                        satSync.enableAutoSync(5); // Sync every 5 minutes
                    });
                }
            }, []);

            const handleNavigation = (destination) => {
                if (destination === 'questionBank') {
                    setMode('menu');
                } else if (destination === 'stats') {
                    setMode('stats');
                } else if (destination === 'home') {
                    setMode('home');
                }
            };

            // Load questions from CB Digital Questions JSON
            useEffect(() => {
                console.log('Loading CB Digital SAT questions...');
                fetch('data/cb-digital-questions.json')
                    .then(res => {
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    })
                    .then(data => {
                        console.log('CB Digital questions data received');

                        let questionsArray = [];

                        if (!Array.isArray(data) && typeof data === 'object') {
                            // CB format is an object with UUIDs as keys
                            const allQuestions = Object.values(data);
                            console.log(`Found ${allQuestions.length} questions in CB format`);

                            questionsArray = allQuestions.map(q => {
                                const content = q.content || {};
                                const isMCQ = content.type === 'mcq' || content.answerOptions;

                                // Build the question text (combine stimulus + stem for English)
                                let questionText = '';
                                if (content.stimulus) {
                                    questionText = content.stimulus;
                                }
                                if (content.stem) {
                                    questionText += (questionText ? '<br><br>' : '') + content.stem;
                                }
                                // For older format with prompt
                                if (content.prompt && !questionText) {
                                    questionText = content.prompt;
                                }

                                // Build answer choices - keep HTML for MathML
                                let choices = null;
                                if (isMCQ && content.answerOptions) {
                                    choices = content.answerOptions.map((opt, idx) => {
                                        const letter = String.fromCharCode(65 + idx);
                                        return {
                                            letter: letter,
                                            content: opt.content || opt.body || '',
                                            id: opt.id
                                        };
                                    });
                                } else if (content.answer && content.answer.choices) {
                                    // Handle alternative format
                                    choices = Object.entries(content.answer.choices).map(([key, val]) => ({
                                        letter: key.toUpperCase(),
                                        content: val.body || '',
                                        id: key
                                    }));
                                }

                                // Get correct answer
                                let correctAnswer = '';
                                if (content.correct_answer && Array.isArray(content.correct_answer)) {
                                    correctAnswer = content.correct_answer[0];
                                } else if (content.answer && content.answer.correct_choice) {
                                    correctAnswer = content.answer.correct_choice.toUpperCase();
                                } else if (content.keys && Array.isArray(content.keys)) {
                                    // For SPR (student produced response), use keys
                                    correctAnswer = content.keys[0];
                                }

                                return {
                                    id: q.questionId || q.uId,
                                    domain: q.primary_class_cd_desc || 'General',
                                    skill: q.skill_desc || '',
                                    module: q.module,
                                    question: questionText,
                                    choices: choices,
                                    correct: correctAnswer,
                                    explanation: content.rationale || content.answer?.rationale || 'No explanation available.',
                                    difficulty: q.difficulty,
                                    format: 'cb-digital'
                                };
                            });

                            console.log(`‚úÖ Parsed ${questionsArray.length} CB Digital questions`);
                            console.log(`Math: ${questionsArray.filter(q => q.module === 'math').length}, English: ${questionsArray.filter(q => q.module === 'english').length}`);
                        } else {
                            console.warn('‚ùå Unexpected data format');
                            questionsArray = [getSampleQuestion()];
                        }

                        setAllQuestions(questionsArray);
                    })
                    .catch(err => {
                        console.error('Error loading CB Digital questions:', err.message);
                        console.log('Using fallback sample question.');
                        setAllQuestions([getSampleQuestion()]);
                    });
            }, []);

            function getSampleQuestion() {
                return {
                    id: "sample-1",
                    topic: "algebra",
                    domain: "Linear Equations",
                    question: "If 2x + 5 = 15, what is the value of x?",
                    choices: ["A) 3", "B) 5", "C) 7", "D) 10"],
                    correct: "B",
                    explanation: "Subtract 5 from both sides: 2x = 10, then divide by 2: x = 5"
                };
            }

            const handleStartTest = (config) => {
                let selected = [];

                // Check if smart selection is enabled and RL model is available
                if (config.smartSelection && satRLModel) {
                    console.log('ü§ñ Using RL-based smart question selection');

                    // Filter questions to selected module only
                    const moduleQuestions = allQuestions.filter(q => q.module === config.module);

                    // Use RL to recommend questions
                    const recommendation = satRLModel.recommendQuestions(moduleQuestions, config.count);
                    selected = recommendation.questions;

                    // Log the reasoning
                    console.log('üéØ RL Recommendations:');
                    console.log(`  Weaknesses: ${recommendation.weaknesses.map(w => `${w.domain} (Œ∏=${w.theta})`).join(', ')}`);
                    recommendation.reasoning.forEach((r, i) => {
                        console.log(`  Q${i + 1}: ${r.reason}`);
                    });

                    // If RL didn't find enough questions, fall back to filtered selection
                    if (selected.length < config.count) {
                        console.warn(`‚ö†Ô∏è RL only found ${selected.length} questions, supplementing with filtered questions`);
                        const filteredQuestions = allQuestions.filter(q => {
                            return q.module === config.module &&
                                   config.disciplines.includes(q.domain) &&
                                   config.difficulties.includes(q.difficulty);
                        });
                        const usedIds = selected.map(q => q.questionId || q.id);
                        const additional = filteredQuestions
                            .filter(q => !usedIds.includes(q.questionId || q.id))
                            .sort(() => Math.random() - 0.5)
                            .slice(0, config.count - selected.length);
                        selected = [...selected, ...additional];
                    }
                } else {
                    // Original random selection
                    console.log('üé≤ Using random question selection');
                    let filteredQuestions = allQuestions.filter(q => {
                        return q.module === config.module &&
                               config.disciplines.includes(q.domain) &&
                               config.difficulties.includes(q.difficulty);
                    });

                    console.log(`Filtered ${filteredQuestions.length} questions for ${config.module} module`);

                    // Shuffle and take the specified count
                    const shuffled = filteredQuestions.sort(() => Math.random() - 0.5);
                    selected = shuffled.slice(0, config.count);
                }

                console.log(`‚úÖ Selected ${selected.length} questions for practice`);

                setTestQuestions(selected);
                setCurrentQuestionIndex(0);
                setUserAnswers({});
                setIsSubmitted(false);
                setQuestionStartTime(Date.now()); // Start timer for first question
                setMode('test');
            };

            const handleAnswer = (answer) => {
                setUserAnswers({
                    ...userAnswers,
                    [testQuestions[currentQuestionIndex].id]: answer
                });
            };

            const saveSATProgress = (questionData, userAnswer, isCorrect) => {
                // Get existing progress
                const progress = JSON.parse(localStorage.getItem('satProgress') || '{}');

                // Initialize if needed
                if (!progress.totalTests) progress.totalTests = 0;
                if (!progress.totalQuestions) progress.totalQuestions = 0;
                if (!progress.totalCorrect) progress.totalCorrect = 0;
                if (!progress.byTopic) progress.byTopic = {};

                // Use domain as topic
                const topic = questionData.domain || 'General';

                // Initialize topic if needed
                if (!progress.byTopic[topic]) {
                    progress.byTopic[topic] = {
                        attempted: 0,
                        correct: 0,
                        accuracy: 0
                    };
                }

                // Update stats
                progress.totalQuestions++;
                progress.byTopic[topic].attempted++;

                if (isCorrect) {
                    progress.totalCorrect++;
                    progress.byTopic[topic].correct++;
                }

                // Calculate accuracy
                progress.byTopic[topic].accuracy = Math.round(
                    (progress.byTopic[topic].correct / progress.byTopic[topic].attempted) * 100
                );

                progress.lastPracticed = new Date().toISOString();

                // Save to localStorage
                localStorage.setItem('satProgress', JSON.stringify(progress));

                // Update study streak
                updateStudyStreak();

                // Update IRT and RL models
                const responseTime = (Date.now() - questionStartTime) / 1000; // Convert to seconds
                const difficulty = questionData.difficulty || 'M';

                // Update IRT model
                if (typeof satIRTModel !== 'undefined') {
                    satIRTModel.updateAbility(topic, isCorrect, difficulty);
                    console.log(`üìä IRT updated - ${topic}: Œ∏ = ${satIRTModel.getAbility(topic).toFixed(2)}`);
                }

                // Update RL model
                if (typeof satRLModel !== 'undefined' && satRLModel !== null) {
                    satRLModel.updateModel(topic, isCorrect, difficulty, responseTime);
                    console.log(`ü§ñ RL updated - ${topic}: Response time ${responseTime.toFixed(1)}s`);
                }

                // Save review to Firebase
                if (satSync) {
                    satSync.saveReview({
                        domain: topic,
                        correct: isCorrect,
                        difficulty: difficulty,
                        questionId: questionData.questionId || questionData.id,
                        responseTime: responseTime,
                        module: questionData.module,
                        theta: satIRTModel ? satIRTModel.getAbility(topic) : 0
                    });
                }

                console.log(`‚úÖ SAT progress saved - Discipline: ${topic}, Correct: ${isCorrect}`);
            };

            const updateStudyStreak = () => {
                const today = new Date().toDateString();
                const lastVisit = localStorage.getItem('lastVisit');

                if (lastVisit !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);

                    let currentStreak = parseInt(localStorage.getItem('studyStreak') || '0');

                    if (lastVisit === yesterday.toDateString()) {
                        currentStreak++;
                    } else if (!lastVisit || lastVisit < yesterday.toDateString()) {
                        currentStreak = 1;
                    }

                    localStorage.setItem('studyStreak', currentStreak.toString());
                    localStorage.setItem('lastVisit', today);
                    console.log(`üî• Study streak updated: ${currentStreak} days`);
                }
            };

            const handleNext = () => {
                setIsSubmitted(false);
                if (currentQuestionIndex < testQuestions.length - 1) {
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                    setQuestionStartTime(Date.now()); // Reset timer for new question
                }
            };

            const handlePrevious = () => {
                setIsSubmitted(false);
                if (currentQuestionIndex > 0) {
                    setCurrentQuestionIndex(currentQuestionIndex - 1);
                    setQuestionStartTime(Date.now()); // Reset timer for new question
                }
            };

            if (mode === 'home') {
                return <HomeScreen onNavigate={handleNavigation} />;
            }

            if (mode === 'stats') {
                return <StatsScreen onBack={() => handleNavigation('home')} />;
            }

            if (mode === 'menu') {
                return <TopicSelectionMenu onStartTest={handleStartTest} allQuestions={allQuestions} onBack={() => handleNavigation('home')} />;
            }

            if (allQuestions.length === 0) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-center">
                            <div className="text-6xl mb-4">üìö</div>
                            <p className="text-xl text-gray-600">Loading questions...</p>
                        </div>
                    </div>
                );
            }

            if (testQuestions.length === 0) {
                return <TopicSelectionMenu onStartTest={handleStartTest} allQuestions={allQuestions} onBack={() => handleNavigation('home')} />;
            }

            const currentQuestion = testQuestions[currentQuestionIndex];
            const questionText = currentQuestion.question;
            const explanation = currentQuestion.explanation;
            const choices = currentQuestion.choices; // Array of {letter, content, id} or null
            const correctAnswer = currentQuestion.correct;

            return (
                <>
                    <div className="flex" style={{ minHeight: 'calc(100vh - 64px)' }}>
                        {/* Sidebar - Progress and Navigation */}
                        <div className="w-64 bg-gray-900 text-white p-6 flex flex-col">
                            <button
                                onClick={() => setMode('menu')}
                                className="text-white hover:bg-white/10 font-semibold mb-6 px-4 py-2 rounded-lg transition-all text-left"
                            >
                                ‚Üê Back to Menu
                            </button>

                            <div className="mb-6">
                                <div className="text-sm text-gray-400 mb-1">Question</div>
                                <div className="text-3xl font-bold text-white">
                                    {currentQuestionIndex + 1} <span className="text-gray-500">/ {testQuestions.length}</span>
                                </div>
                            </div>

                            <div className="mb-6">
                                <div className="text-sm text-gray-400 mb-2">Progress</div>
                                <div className="bg-gray-700 rounded-full h-2 mb-2">
                                    <div
                                        className="bg-gradient-to-r from-purple-500 to-blue-500 h-2 rounded-full transition-all duration-300"
                                        style={{ width: `${((currentQuestionIndex + 1) / testQuestions.length) * 100}%` }}
                                    />
                                </div>
                                <div className="text-xs text-gray-400">
                                    {Math.round(((currentQuestionIndex + 1) / testQuestions.length) * 100)}% complete
                                </div>
                            </div>

                            <div className="mb-6">
                                <div className="text-sm text-gray-400 mb-2">Module</div>
                                <div className="px-3 py-1 bg-purple-600 rounded-full text-sm font-semibold inline-block">
                                    {currentQuestion.module === 'math' ? 'üî¢ Math' : 'üìö Reading & Writing'}
                                </div>
                            </div>

                            <div className="mb-6">
                                <div className="text-sm text-gray-400 mb-2">Discipline</div>
                                <div className="text-sm font-semibold text-white">
                                    {currentQuestion.domain}
                                </div>
                                {currentQuestion.skill && (
                                    <div className="text-xs text-gray-400 mt-1">
                                        {currentQuestion.skill}
                                    </div>
                                )}
                            </div>

                            <div className="mb-6">
                                <div className="text-sm text-gray-400 mb-2">Difficulty</div>
                                <div className={`px-2 py-1 rounded text-xs font-bold inline-block ${
                                    currentQuestion.difficulty === 'H' ? 'bg-red-500' :
                                    currentQuestion.difficulty === 'M' ? 'bg-yellow-500' : 'bg-green-500'
                                }`}>
                                    {currentQuestion.difficulty === 'H' ? 'Hard' :
                                     currentQuestion.difficulty === 'M' ? 'Medium' : 'Easy'}
                                </div>
                            </div>

                            <div className="flex-1"></div>

                            <div className="space-y-3">
                                <button
                                    onClick={handlePrevious}
                                    disabled={currentQuestionIndex === 0}
                                    className="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 disabled:opacity-30 disabled:cursor-not-allowed rounded-lg font-semibold transition-all"
                                >
                                    ‚Üê Previous
                                </button>
                                <button
                                    onClick={handleNext}
                                    disabled={currentQuestionIndex === testQuestions.length - 1}
                                    className="w-full px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-500 hover:opacity-90 rounded-lg font-semibold transition-all disabled:opacity-30 disabled:cursor-not-allowed"
                                >
                                    Next ‚Üí
                                </button>
                            </div>
                        </div>

                        {/* Main Content Area */}
                        <div className="flex-1 flex">
                            {/* Question Panel */}
                            <div className="flex-1 question-panel overflow-y-auto p-8">
                                <div className="max-w-4xl">
                                    <div className="mb-6">
                                        <MathText text={questionText} className="text-xl leading-relaxed text-gray-900" />
                                    </div>

                                    {isSubmitted && (
                                        <div className="mt-8 p-6 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                                            <h4 className="font-bold text-blue-900 mb-3 text-lg">Explanation</h4>
                                            <MathText text={explanation || 'No explanation available.'} className="text-blue-800" />
                                        </div>
                                    )}
                                </div>
                            </div>

                        {/* Right Panel - Answers & Widgets */}
                        <div className="answer-panel overflow-y-auto">
                            {/* Widget Toggles */}
                            <div className="flex gap-2 mb-6">
                                <button
                                    onClick={() => setShowCalculator(!showCalculator)}
                                    className={`widget-toggle ${showCalculator ? 'active' : ''}`}
                                >
                                    üßÆ Calculator
                                </button>
                                {showCalculator && (
                                    <select
                                        value={calculatorMode}
                                        onChange={(e) => setCalculatorMode(e.target.value)}
                                        className="px-3 py-1 border-2 border-gray-300 rounded-lg text-sm font-semibold"
                                    >
                                        <option value="graphing">Graphing</option>
                                        <option value="scientific">Scientific</option>
                                    </select>
                                )}
                            </div>

                            {/* Answer Section */}
                            <div className="mb-6">
                                <h3 className="text-lg font-bold mb-4 text-gray-800">
                                    {choices ? 'Answer Choices' : 'Your Answer'}
                                </h3>

                                {/* Multiple Choice */}
                                {choices && (
                                    <div className="space-y-3">
                                        {choices.map((choice, idx) => {
                                            const letter = choice.letter;
                                            const content = choice.content;

                                            const isSelected = userAnswers[currentQuestion.id] === letter;
                                            const isCorrect = letter === correctAnswer;

                                            let className = 'choice-option';
                                            if (isSubmitted) {
                                                if (isCorrect) className += ' correct';
                                                else if (isSelected) className += ' incorrect';
                                            } else if (isSelected) {
                                                className += ' selected';
                                            }

                                            return (
                                                <div
                                                    key={choice.id || idx}
                                                    onClick={() => !isSubmitted && handleAnswer(letter)}
                                                    className={className}
                                                >
                                                    <div className="flex items-start">
                                                        <span className="font-bold mr-3 text-gray-900 flex-shrink-0">{letter})</span>
                                                        <MathText text={content} className="text-gray-800 flex-1" />
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                {/* Free Response */}
                                {!choices && (
                                    <div>
                                        <input
                                            type="text"
                                            value={userAnswers[currentQuestion.id] || ''}
                                            onChange={(e) => handleAnswer(e.target.value)}
                                            disabled={isSubmitted}
                                            placeholder="Enter your answer (number or fraction)"
                                            className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg font-medium focus:border-purple-500 focus:outline-none"
                                        />
                                        {isSubmitted && (
                                            <div className="mt-3 text-sm text-gray-600">
                                                <strong>Correct answer:</strong> {correctAnswer}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {!isSubmitted && userAnswers[currentQuestion.id] && (
                                <button
                                    onClick={() => {
                                        setIsSubmitted(true);
                                        // Save progress when answer is checked
                                        const userAns = userAnswers[currentQuestion.id];
                                        const isCorrect = userAns === correctAnswer;
                                        saveSATProgress(currentQuestion, userAns, isCorrect);
                                    }}
                                    className="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-bold hover:opacity-90 transition-all mb-6"
                                >
                                    Check Answer
                                </button>
                            )}
                        </div>
                        </div>
                    </div>

                    {/* Draggable Widgets */}
                    {showCalculator && (
                        <DraggableWidget
                            title={`Desmos ${calculatorMode === 'graphing' ? 'Graphing' : 'Scientific'} Calculator`}
                            initialX={window.innerWidth - 550}
                            initialY={100}
                            initialWidth={500}
                            initialHeight={600}
                            onClose={() => setShowCalculator(false)}
                        >
                            <DesmosCalculator mode={calculatorMode} />
                        </DraggableWidget>
                    )}
                </>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <>
                <Navigation />
                <Breadcrumb items={[
                    { label: 'Dashboard', href: 'dashboard' },
                    { label: 'SAT Practice' }
                ]} />
                <SATApp />
            </>
        );
    </script>

    <script src="toast-notifications.js"></script>
</body>
</html>
